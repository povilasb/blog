<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="../assets/xml/rss.xsl" media="all"?><rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Povilas Blog (Posts about starttls)</title><link>http://blog.povilasb.com/</link><description></description><atom:link href="http://blog.povilasb.com/categories/starttls.xml" rel="self" type="application/rss+xml"></atom:link><language>en</language><lastBuildDate>Sun, 11 Dec 2022 18:28:53 GMT</lastBuildDate><generator>Nikola (getnikola.com)</generator><docs>http://blogs.law.harvard.edu/tech/rss</docs><item><title>Opportunistic TLS with python asyncio</title><link>http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/</link><dc:creator>Povilas Balciunas</dc:creator><description>&lt;p&gt;Recently I was implementing an HTTPS proxy that was doing a man in the middle
attack similar to what &lt;a class="reference external" href="https://mitmproxy.org/"&gt;https://mitmproxy.org/&lt;/a&gt; does.
This server upgrades TCP connection to TLS on &lt;a class="reference external" href="https://en.wikipedia.org/wiki/HTTP_tunnel#HTTP_CONNECT_tunneling"&gt;HTTP CONNECT&lt;/a&gt; method.
While researching how to do this with asyncio I came across this python
issue &lt;a class="reference external" href="https://bugs.python.org/issue23749"&gt;https://bugs.python.org/issue23749&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;After reading the discussion it was clear that &lt;cite&gt;asyncio.sslproto.SSLProtocol&lt;/cite&gt;
has TLS/SSL implementation.
Also Yury Selivanov posted a recent patch that allows us to wrap application
protocol inside &lt;cite&gt;SSLProtocol&lt;/cite&gt;: &lt;a class="reference external" href="https://hg.python.org/cpython/rev/3e6739e5c2d0"&gt;https://hg.python.org/cpython/rev/3e6739e5c2d0&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Eventually, I ended up with a prototype:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code python"&gt;&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-1" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-1" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-1"&gt;&lt;/a&gt;&lt;span class="c1"&gt;# https://github.com/benoitc/http-parser/&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-2" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-2" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-2"&gt;&lt;/a&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;http_parser.parser&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;HttpParser&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-3" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-3" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-3"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-4" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-4" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-4"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-5" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-5" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-5"&gt;&lt;/a&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;HttpServerProtocol&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;asyncio&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Protocol&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-6" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-6" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-6"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-7" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-7" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-7"&gt;&lt;/a&gt;        &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-8" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-8" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-8"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_http_parser&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;HttpParser&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-9" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-9" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-9"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_transport&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-10" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-10" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-10"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-11" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-11" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-11"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;request_received&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-12" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-12" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-12"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_transport&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-13" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-13" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-13"&gt;&lt;/a&gt;            &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;'HTTP/1.1 200 OK&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s1"&gt;'&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-14" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-14" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-14"&gt;&lt;/a&gt;            &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;'Content-Length: 2&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s1"&gt;'&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-15" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-15" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-15"&gt;&lt;/a&gt;            &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;'Connection: close&lt;/span&gt;&lt;span class="se"&gt;\r\n\r\n&lt;/span&gt;&lt;span class="s1"&gt;'&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-16" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-16" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-16"&gt;&lt;/a&gt;            &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;'OK'&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-17" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-17" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-17"&gt;&lt;/a&gt;        &lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-18" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-18" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-18"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_transport&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-19" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-19" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-19"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-20" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-20" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-20"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;data_received&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;bytes&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-21" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-21" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-21"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_http_parser&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;execute&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-22" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-22" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-22"&gt;&lt;/a&gt;        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_http_parser&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;is_message_complete&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-23" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-23" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-23"&gt;&lt;/a&gt;            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;request_received&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-24" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-24" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-24"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-25" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-25" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-25"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;connection_made&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;transport&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-26" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-26" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-26"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_transport&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;transport&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-27" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-27" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-27"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-28" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-28" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-28"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;close&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-29" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-29" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-29"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_transport&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-30" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-30" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-30"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-31" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-31" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-31"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-32" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-32" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-32"&gt;&lt;/a&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;HttpsServerProtocol&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;HttpServerProtocol&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-33" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-33" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-33"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-34" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-34" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-34"&gt;&lt;/a&gt;        &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-35" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-35" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-35"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-36" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-36" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-36"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_over_tls&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;False&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-37" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-37" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-37"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_tls_proto&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;asyncio&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sslproto&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SSLProtocol&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-38" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-38" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-38"&gt;&lt;/a&gt;            &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;HttpServerProtocol&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;make_tls_context&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-39" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-39" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-39"&gt;&lt;/a&gt;            &lt;span class="n"&gt;server_side&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-40" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-40" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-40"&gt;&lt;/a&gt;        &lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-41" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-41" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-41"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-42" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-42" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-42"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;connect_received&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-43" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-43" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-43"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_over_tls&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;True&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-44" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-44" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-44"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_tls_proto&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;connection_made&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_transport&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-45" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-45" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-45"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-46" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-46" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-46"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;request_received&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-47" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-47" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-47"&gt;&lt;/a&gt;        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_http_parser&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_method&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s1"&gt;'CONNECT'&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-48" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-48" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-48"&gt;&lt;/a&gt;            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_transport&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;'HTTP/1.1 200 OK&lt;/span&gt;&lt;span class="se"&gt;\r\n\r\n&lt;/span&gt;&lt;span class="s1"&gt;'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-49" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-49" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-49"&gt;&lt;/a&gt;            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;connect_received&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-50" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-50" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-50"&gt;&lt;/a&gt;        &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-51" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-51" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-51"&gt;&lt;/a&gt;            &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;request_received&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-52" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-52" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-52"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-53" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-53" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-53"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;data_received&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;bytes&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-54" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-54" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-54"&gt;&lt;/a&gt;        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_over_tls&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-55" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-55" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-55"&gt;&lt;/a&gt;            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_tls_proto&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;data_received&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-56" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-56" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-56"&gt;&lt;/a&gt;        &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-57" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-57" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-57"&gt;&lt;/a&gt;            &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;data_received&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-58" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-58" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-58"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-59" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-59" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-59"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-60" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-60" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-60"&gt;&lt;/a&gt;&lt;span class="k"&gt;async&lt;/span&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;start_server&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-61" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-61" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-61"&gt;&lt;/a&gt;    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;create_server&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-62" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-62" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-62"&gt;&lt;/a&gt;        &lt;span class="k"&gt;lambda&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;HttpsServerProtocol&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="s1"&gt;'0.0.0.0'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;8082&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;backlog&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;65535&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-63" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-63" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-63"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-64" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-64" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-64"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-65" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-65" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-65"&gt;&lt;/a&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;make_tls_context&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-66" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-66" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-66"&gt;&lt;/a&gt;    &lt;span class="n"&gt;ctx&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ssl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SSLContext&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ssl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;PROTOCOL_SSLv23&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-67" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-67" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-67"&gt;&lt;/a&gt;    &lt;span class="n"&gt;ctx&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;load_cert_chain&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'example.com.crt'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'https.key.pem'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-68" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-68" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-68"&gt;&lt;/a&gt;    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ctx&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-69" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-69" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-69"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-70" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-70" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-70"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-71" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-71" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-71"&gt;&lt;/a&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;main&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-72" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-72" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-72"&gt;&lt;/a&gt;    &lt;span class="n"&gt;loop&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;asyncio&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;new_event_loop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-73" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-73" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-73"&gt;&lt;/a&gt;    &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;run_until_complete&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start_server&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-74" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-74" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-74"&gt;&lt;/a&gt;    &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;run_forever&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-75" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-75" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-75"&gt;&lt;/a&gt;    &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Initially I have &lt;cite&gt;HttpServerProtocol&lt;/cite&gt; which receives data stream, parses
HTTP messages and calls &lt;cite&gt;request_received&lt;/cite&gt; which returns just a dummy response:&lt;/p&gt;
&lt;pre class="literal-block"&gt;➜  ~ curl http://localhost:8082/any/path -v
&amp;gt; GET /any/path HTTP/1.1
&amp;gt; User-Agent: curl/7.38.0
&amp;gt; Host: localhost:8082
&amp;gt; Accept: */*
&amp;gt;
&amp;lt; HTTP/1.1 200 OK
&amp;lt; Content-Length: 2
&amp;lt; Connection: close
&amp;lt;

OK&lt;/pre&gt;
&lt;p&gt;Then I have &lt;cite&gt;HttpsServerProtocol&lt;/cite&gt; which is just the extension of
&lt;cite&gt;HttpServerProtocol&lt;/cite&gt; but also is capable of upgrading connection to TLS.
The way it works is, it overrides &lt;cite&gt;request_received()&lt;/cite&gt; method which
checks if HTTP request is &lt;cite&gt;CONNECT&lt;/cite&gt;.
If it is, &lt;cite&gt;HttpsServerProtocol&lt;/cite&gt; tells &lt;cite&gt;SSLProtocol&lt;/cite&gt; to handle a new connection:&lt;/p&gt;
&lt;pre class="literal-block"&gt;def connect_received(self) -&amp;gt; None:
    self._over_tls = True
    self._tls_proto.connection_made(self._transport)&lt;/pre&gt;
&lt;p&gt;Then &lt;cite&gt;SSLProtocol&lt;/cite&gt; does the TLS handshake and data encryption/decryption:&lt;/p&gt;
&lt;pre class="literal-block"&gt;➜  ~ curl --proxy localhost:8082 https://dummy.org -k -v
&amp;gt; CONNECT dummy.org:443 HTTP/1.1
&amp;gt; Host: dummy.org:443
&amp;gt; User-Agent: curl/7.38.0
&amp;gt; Proxy-Connection: Keep-Alive
&amp;gt;
&amp;lt; HTTP/1.1 200 OK
&amp;lt;
* Proxy replied OK to CONNECT request
* successfully set certificate verify locations:
*   CAfile: none
  CApath: /etc/ssl/certs
* SSLv3, TLS handshake, Client hello (1):
* SSLv3, TLS handshake, Server hello (2):
* SSLv3, TLS handshake, CERT (11):
* SSLv3, TLS handshake, Server key exchange (12):
* SSLv3, TLS handshake, Server finished (14):
* SSLv3, TLS handshake, Client key exchange (16):
* SSLv3, TLS change cipher, Client hello (1):
* SSLv3, TLS handshake, Finished (20):
* SSLv3, TLS change cipher, Client hello (1):
* SSLv3, TLS handshake, Finished (20):
* SSL connection using TLSv1.2 / ECDHE-RSA-AES256-GCM-SHA384
* Server certificate:
*        subject: CN=dummy.org
*        start date: 2017-02-02 08:28:42 GMT
*        expire date: 2017-02-02 08:28:42 GMT
*        issuer: CN=development ca
*        SSL certificate verify result: unable to get local issuer certificate (20), continuing anyway.
&amp;gt; GET / HTTP/1.1
&amp;gt; User-Agent: curl/7.38.0
&amp;gt; Host: dummy.org
&amp;gt; Accept: */*
&amp;gt;
&amp;lt; HTTP/1.1 200 OK
&amp;lt; Content-Length: 2
&amp;lt; Connection: close
&amp;lt;
OK&lt;/pre&gt;
&lt;p&gt;When &lt;cite&gt;SSLProtocol&lt;/cite&gt; receives some data, it decrypts it and passes to
&lt;cite&gt;HttpServerProtocol.data_received()&lt;/cite&gt;.
And from now on we're communicating over TLS.&lt;/p&gt;</description><category>asyncio</category><category>python3</category><category>ssl</category><category>starttls</category><category>tls</category><guid>http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/</guid><pubDate>Mon, 20 Feb 2017 05:40:47 GMT</pubDate></item></channel></rss>