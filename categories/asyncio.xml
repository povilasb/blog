<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="../assets/xml/rss.xsl" media="all"?><rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Povilas Blog (Posts about asyncio)</title><link>http://blog.povilasb.com/</link><description></description><atom:link href="http://blog.povilasb.com/categories/asyncio.xml" rel="self" type="application/rss+xml"></atom:link><language>en</language><lastBuildDate>Sun, 11 Dec 2022 18:28:53 GMT</lastBuildDate><generator>Nikola (getnikola.com)</generator><docs>http://blogs.law.harvard.edu/tech/rss</docs><item><title>Python asyncio vs nginx performance</title><link>http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/</link><dc:creator>Povilas Balciunas</dc:creator><description>&lt;p&gt;While I was playing with Python asyncio I got interested in how well
it performs serving data over TLS compared to Nginx.
So I implemented a small HTTPS server with asyncio:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code python"&gt;&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-1" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-1" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-1"&gt;&lt;/a&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;asyncio&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-2" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-2" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-2"&gt;&lt;/a&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;ssl&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-3" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-3" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-3"&gt;&lt;/a&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;random&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-4" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-4" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-4"&gt;&lt;/a&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;string&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-5" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-5" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-5"&gt;&lt;/a&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-6" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-6" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-6"&gt;&lt;/a&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;uvloop&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-7" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-7" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-7"&gt;&lt;/a&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-8" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-8" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-8"&gt;&lt;/a&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-9" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-9" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-9"&gt;&lt;/a&gt;&lt;span class="n"&gt;content_20k&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;''&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;random&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;choice&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ascii_uppercase&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;string&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;digits&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-10" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-10" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-10"&gt;&lt;/a&gt;                      &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;_&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;20&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="mi"&gt;1024&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-11" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-11" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-11"&gt;&lt;/a&gt;&lt;span class="n"&gt;resp_lines&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-12" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-12" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-12"&gt;&lt;/a&gt;    &lt;span class="s1"&gt;'HTTP/1.1 200 OK'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-13" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-13" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-13"&gt;&lt;/a&gt;    &lt;span class="s1"&gt;'Connection: close'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-14" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-14" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-14"&gt;&lt;/a&gt;    &lt;span class="s1"&gt;''&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-15" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-15" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-15"&gt;&lt;/a&gt;    &lt;span class="s1"&gt;''&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-16" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-16" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-16"&gt;&lt;/a&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-17" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-17" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-17"&gt;&lt;/a&gt;&lt;span class="n"&gt;resp_20k&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;bytes&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s1"&gt;'&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;resp_lines&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;content_20k&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'latin-1'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-18" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-18" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-18"&gt;&lt;/a&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-19" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-19" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-19"&gt;&lt;/a&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-20" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-20" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-20"&gt;&lt;/a&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;HttpServerProtocol&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;asyncio&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Protocol&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-21" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-21" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-21"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-22" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-22" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-22"&gt;&lt;/a&gt;        &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-23" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-23" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-23"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_transport&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-24" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-24" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-24"&gt;&lt;/a&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-25" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-25" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-25"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;request_received&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-26" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-26" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-26"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_transport&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;bytes&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;resp_20k&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-27" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-27" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-27"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_transport&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-28" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-28" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-28"&gt;&lt;/a&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-29" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-29" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-29"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;data_received&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;bytes&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-30" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-30" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-30"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# Let's assume request is complete.&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-31" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-31" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-31"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;request_received&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-32" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-32" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-32"&gt;&lt;/a&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-33" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-33" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-33"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;connection_made&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;transport&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-34" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-34" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-34"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_transport&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;transport&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-35" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-35" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-35"&gt;&lt;/a&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-36" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-36" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-36"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;close&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-37" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-37" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-37"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_transport&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-38" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-38" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-38"&gt;&lt;/a&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-39" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-39" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-39"&gt;&lt;/a&gt;&lt;span class="k"&gt;async&lt;/span&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;start_https_server&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-40" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-40" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-40"&gt;&lt;/a&gt;    &lt;span class="n"&gt;tls_ctx&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;make_tls_context&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-41" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-41" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-41"&gt;&lt;/a&gt;    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;create_server&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-42" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-42" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-42"&gt;&lt;/a&gt;        &lt;span class="k"&gt;lambda&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;asyncio&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sslproto&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SSLProtocol&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-43" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-43" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-43"&gt;&lt;/a&gt;            &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;HttpServerProtocol&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;tls_ctx&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;server_side&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-44" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-44" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-44"&gt;&lt;/a&gt;        &lt;span class="s1"&gt;'0.0.0.0'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;8082&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;backlog&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;65535&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-45" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-45" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-45"&gt;&lt;/a&gt;    &lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-46" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-46" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-46"&gt;&lt;/a&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-47" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-47" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-47"&gt;&lt;/a&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;make_tls_context&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-48" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-48" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-48"&gt;&lt;/a&gt;    &lt;span class="n"&gt;ctx&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ssl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SSLContext&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ssl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;PROTOCOL_TLS&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-49" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-49" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-49"&gt;&lt;/a&gt;    &lt;span class="n"&gt;ctx&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;load_cert_chain&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-50" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-50" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-50"&gt;&lt;/a&gt;        &lt;span class="n"&gt;certfile&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;'example.com.crt'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-51" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-51" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-51"&gt;&lt;/a&gt;        &lt;span class="n"&gt;keyfile&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;'https.key.pem'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-52" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-52" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-52"&gt;&lt;/a&gt;    &lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-53" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-53" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-53"&gt;&lt;/a&gt;    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ctx&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-54" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-54" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-54"&gt;&lt;/a&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-55" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-55" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-55"&gt;&lt;/a&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;main&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-56" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-56" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-56"&gt;&lt;/a&gt;    &lt;span class="n"&gt;asyncio&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;set_event_loop_policy&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;uvloop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;EventLoopPolicy&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-57" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-57" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-57"&gt;&lt;/a&gt;    &lt;span class="n"&gt;loop&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;asyncio&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;new_event_loop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-58" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-58" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-58"&gt;&lt;/a&gt;    &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;run_until_complete&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start_https_server&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-59" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-59" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-59"&gt;&lt;/a&gt;    &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;run_forever&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-60" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-60" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-60"&gt;&lt;/a&gt;    &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-61" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-61" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-61"&gt;&lt;/a&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-62" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-62" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-62"&gt;&lt;/a&gt;&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="vm"&gt;__name__&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s1"&gt;'__main__'&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-63" name="rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-63" href="http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/#rest_code_b4b873f7c5d944adb93ffd4ddb4505a9-63"&gt;&lt;/a&gt;    &lt;span class="n"&gt;main&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;All it does is simply serves a static 20k content over TLS.
I configure nginx to do the same.&lt;/p&gt;
&lt;p&gt;Then I ran a small benchmark with &lt;a class="reference external" href="http://github.com/povilasb/httpmeter"&gt;httpmeter&lt;/a&gt;. I am doing one request per connection
as I am mainly interested in TLS performance.
Here's the results for asyncio based server:&lt;/p&gt;
&lt;pre class="literal-block"&gt;$ httpmeter -c 1000 -n 3000 -H 'Connection: close' https://192.168.2.222:8082/
Concurrency Level:        1000
Completed Requests:       3000
Requests Per Second:      544.186120 [#/sec] (mean)
Request Durations:        [min: 0.147766, avg: 1.016474, max: 1.847824] seconds
Document Length:          [min: 20480, avg: 20480.000000, max: 20480] bytes
Status codes:
        200 3000&lt;/pre&gt;
&lt;p&gt;And here's for nginx:&lt;/p&gt;
&lt;pre class="literal-block"&gt;$ httpmeter -c 1000 -n 3000 -H 'Connection: close' https://192.168.2.222:8443/20k
Concurrency Level:        1000
Completed Requests:       3000
Requests Per Second:      1210.957884 [#/sec] (mean)
Request Durations:        [min: 0.068251, avg: 0.454704, max: 0.834079] seconds
Document Length:          [min: 20480, avg: 20480.000000, max: 20480] bytes
Status codes:
        200 3000&lt;/pre&gt;
&lt;p&gt;Both nginx and python server loaded up to 100% single CPU core.&lt;/p&gt;
&lt;p&gt;Basically nginx performed 2x better than asyncio.&lt;/p&gt;
&lt;p&gt;I profiled the asyncio server:&lt;/p&gt;
&lt;pre class="literal-block"&gt;$ pyenv/bin/python server.py
     361637 function calls (361625 primitive calls) in 9.351 seconds

Ordered by: internal time

ncalls  tottime  percall  cumtime  percall filename:lineno(function)
 9000    4.770    0.001    4.770    0.001 {method 'do_handshake' of '_ssl._SSLSocket' objects}
    1    4.088    4.088    9.349    9.349 {method 'run_forever' of 'uvloop.loop.Loop' objects}
15000    0.076    0.000    4.975    0.000 sslproto.py:169(feed_ssldata)
 3000    0.068    0.000    0.068    0.000 {method 'write' of '_ssl._SSLSocket' objects}
 9000    0.045    0.000    0.045    0.000 {method 'read' of '_ssl._SSLSocket' objects}
12000    0.033    0.000    0.221    0.000 sslproto.py:624(_process_write_backlog)
 3000    0.024    0.000    0.025    0.000 sslproto.py:413(__init__)
 9000    0.018    0.000    5.107    0.001 sslproto.py:497(data_received)
 3000    0.017    0.000    0.035    0.000 sslproto.py:572(_on_handshake_complete)
 3000    0.015    0.000    0.015    0.000 {method '_wrap_bio' of '_ssl._SSLContext' objects}
12000    0.013    0.000    0.013    0.000 {method 'read' of '_ssl.MemoryBIO' objects}
 3000    0.012    0.000    0.012    0.000 {method 'shutdown' of '_ssl._SSLSocket' objects}
 3000    0.012    0.000    0.091    0.000 sslproto.py:243(feed_appdata)
 9000    0.010    0.000    4.782    0.001 ssl.py:681(do_handshake)
 3000    0.009    0.000    0.019    0.000 sslproto.py:460(connection_made)
12000    0.008    0.000    0.008    0.000 {method 'write' of 'uvloop.loop.UVStream' objects}
 6000    0.007    0.000    0.155    0.000 sslproto.py:555(_write_appdata)
 9000    0.007    0.000    0.007    0.000 {method 'write' of '_ssl.MemoryBIO' objects}
 3000    0.006    0.000    0.061    0.000 sslproto.py:118(do_handshake)
 3000    0.006    0.000    0.168    0.000 server.py:25(request_received)
 3000    0.006    0.000    0.008    0.000 sslproto.py:521(eof_received)
48045    0.005    0.000    0.005    0.000 {built-in method builtins.len}
 3000    0.005    0.000    0.005    0.000 sslproto.py:68(__init__)
 3000    0.005    0.000    0.034    0.000 server.py:43(&amp;lt;lambda&amp;gt;)
 9000    0.005    0.000    0.050    0.000 ssl.py:618(read)
 9000    0.005    0.000    0.005    0.000 {method 'call_soon' of 'uvloop.loop.Loop' objects}
15018    0.005    0.000    0.005    0.000 {built-in method builtins.getattr}
 3000    0.004    0.000    0.009    0.000 weakref.py:155(__setitem__)
 3000    0.004    0.000    0.030    0.000 sslproto.py:139(shutdown)
 3000    0.004    0.000    0.021    0.000 ssl.py:403(wrap_bio)
 3000    0.004    0.000    0.006    0.000 sslproto.py:471(connection_lost)
 3000    0.003    0.000    0.114    0.000 sslproto.py:379(write)
 3000    0.003    0.000    0.003    0.000 server.py:21(__init__)
 3000    0.003    0.000    0.005    0.000 sslproto.py:560(_start_handshake)
 3000    0.003    0.000    0.003    0.000 {method 'cipher' of '_ssl._SSLSocket' objects}
 3000    0.003    0.000    0.003    0.000 {method 'update' of 'dict' objects}
15028    0.002    0.000    0.002    0.000 {method 'append' of 'list' objects}
 3000    0.002    0.000    0.004    0.000 ssl.py:638(getpeercert)
 3000    0.002    0.000    0.002    0.000 weakref.py:310(__init__)
 3000    0.002    0.000    0.002    0.000 ssl.py:577(__init__)
 3000    0.002    0.000    0.048    0.000 sslproto.py:317(close)
 3000    0.002    0.000    0.002    0.000 {method 'peer_certificate' of '_ssl._SSLSocket' objects}
 3000    0.002    0.000    0.014    0.000 ssl.py:690(unwrap)
 9000    0.002    0.000    0.002    0.000 sslproto.py:450(_wakeup_waiter)
 3000    0.002    0.000    0.046    0.000 sslproto.py:549(_start_shutdown)
 3000    0.001    0.000    0.003    0.000 weakref.py:305(__new__)
 3000    0.001    0.000    0.001    0.000 {method 'close' of 'uvloop.loop.UVBaseTransport' objects}
 3000    0.001    0.000    0.001    0.000 ssl.py:584(context)
 3000    0.001    0.000    0.170    0.000 server.py:29(data_received)
 1454    0.001    0.000    0.001    0.000 weakref.py:108(remove)
 3002    0.001    0.000    0.001    0.000 {built-in method __new__ of type object at 0x88d200}
 3000    0.001    0.000    0.069    0.000 ssl.py:630(write)
 3000    0.001    0.000    0.001    0.000 sslproto.py:297(__init__)
 9000    0.001    0.000    0.001    0.000 {method 'get_debug' of 'uvloop.loop.Loop' objects}
 3000    0.001    0.000    0.004    0.000 ssl.py:661(cipher)
 3000    0.001    0.000    0.002    0.000 ssl.py:672(compression)
 9000    0.001    0.000    0.001    0.000 {method 'append' of 'collections.deque' objects}
 3000    0.001    0.000    0.001    0.000 server.py:33(connection_made)
 3018    0.001    0.000    0.001    0.000 {built-in method builtins.hasattr}
 3022    0.001    0.000    0.001    0.000 {built-in method builtins.isinstance}
 3000    0.001    0.000    0.001    0.000 sslproto.py:95(ssl_object)
 3000    0.000    0.000    0.000    0.000 {method 'compression' of '_ssl._SSLSocket' objects}
 3000    0.000    0.000    0.000    0.000 protocols.py:94(eof_received)
    2    0.000    0.000    0.000    0.000 sre_compile.py:250(_optimize_charset)
 3000    0.000    0.000    0.000    0.000 protocols.py:25(connection_lost)
 2397    0.000    0.000    0.000    0.000 sslproto.py:332(__del__)&lt;/pre&gt;
&lt;p&gt;It turns out that most of the time is spent doing TLS handshake.
This is weird because I expected TLS to perform similar to nginx because
python is only wrapping OpenSSL C implementation.&lt;/p&gt;
&lt;p&gt;One of the possible improvements that nginx could have is TLS session
resumption.
But it's not possible in this case because I used &lt;cite&gt;httpmeter&lt;/cite&gt; which is
implemented in python.
And by the time I ran benchmarks, python TLS API did not support TLS sessions
(&lt;a class="reference external" href="https://bugs.python.org/issue19500"&gt;https://bugs.python.org/issue19500&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;So I need to do more research to better understand nginx over python asyncio
TLS performance.&lt;/p&gt;</description><category>asyncio</category><category>python</category><category>tls</category><guid>http://blog.povilasb.com/posts/python-asyncio-vs-nginx-performance/</guid><pubDate>Fri, 24 Feb 2017 15:23:38 GMT</pubDate></item><item><title>Opportunistic TLS with python asyncio</title><link>http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/</link><dc:creator>Povilas Balciunas</dc:creator><description>&lt;p&gt;Recently I was implementing an HTTPS proxy that was doing a man in the middle
attack similar to what &lt;a class="reference external" href="https://mitmproxy.org/"&gt;https://mitmproxy.org/&lt;/a&gt; does.
This server upgrades TCP connection to TLS on &lt;a class="reference external" href="https://en.wikipedia.org/wiki/HTTP_tunnel#HTTP_CONNECT_tunneling"&gt;HTTP CONNECT&lt;/a&gt; method.
While researching how to do this with asyncio I came across this python
issue &lt;a class="reference external" href="https://bugs.python.org/issue23749"&gt;https://bugs.python.org/issue23749&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;After reading the discussion it was clear that &lt;cite&gt;asyncio.sslproto.SSLProtocol&lt;/cite&gt;
has TLS/SSL implementation.
Also Yury Selivanov posted a recent patch that allows us to wrap application
protocol inside &lt;cite&gt;SSLProtocol&lt;/cite&gt;: &lt;a class="reference external" href="https://hg.python.org/cpython/rev/3e6739e5c2d0"&gt;https://hg.python.org/cpython/rev/3e6739e5c2d0&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Eventually, I ended up with a prototype:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code python"&gt;&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-1" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-1" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-1"&gt;&lt;/a&gt;&lt;span class="c1"&gt;# https://github.com/benoitc/http-parser/&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-2" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-2" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-2"&gt;&lt;/a&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;http_parser.parser&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;HttpParser&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-3" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-3" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-3"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-4" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-4" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-4"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-5" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-5" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-5"&gt;&lt;/a&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;HttpServerProtocol&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;asyncio&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Protocol&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-6" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-6" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-6"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-7" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-7" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-7"&gt;&lt;/a&gt;        &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-8" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-8" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-8"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_http_parser&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;HttpParser&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-9" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-9" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-9"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_transport&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-10" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-10" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-10"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-11" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-11" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-11"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;request_received&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-12" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-12" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-12"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_transport&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-13" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-13" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-13"&gt;&lt;/a&gt;            &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;'HTTP/1.1 200 OK&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s1"&gt;'&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-14" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-14" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-14"&gt;&lt;/a&gt;            &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;'Content-Length: 2&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s1"&gt;'&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-15" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-15" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-15"&gt;&lt;/a&gt;            &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;'Connection: close&lt;/span&gt;&lt;span class="se"&gt;\r\n\r\n&lt;/span&gt;&lt;span class="s1"&gt;'&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-16" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-16" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-16"&gt;&lt;/a&gt;            &lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;'OK'&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-17" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-17" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-17"&gt;&lt;/a&gt;        &lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-18" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-18" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-18"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_transport&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-19" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-19" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-19"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-20" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-20" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-20"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;data_received&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;bytes&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-21" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-21" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-21"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_http_parser&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;execute&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-22" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-22" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-22"&gt;&lt;/a&gt;        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_http_parser&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;is_message_complete&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-23" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-23" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-23"&gt;&lt;/a&gt;            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;request_received&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-24" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-24" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-24"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-25" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-25" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-25"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;connection_made&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;transport&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-26" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-26" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-26"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_transport&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;transport&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-27" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-27" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-27"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-28" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-28" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-28"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;close&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-29" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-29" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-29"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_transport&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-30" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-30" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-30"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-31" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-31" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-31"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-32" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-32" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-32"&gt;&lt;/a&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;HttpsServerProtocol&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;HttpServerProtocol&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-33" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-33" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-33"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-34" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-34" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-34"&gt;&lt;/a&gt;        &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-35" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-35" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-35"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-36" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-36" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-36"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_over_tls&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;False&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-37" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-37" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-37"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_tls_proto&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;asyncio&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sslproto&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SSLProtocol&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-38" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-38" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-38"&gt;&lt;/a&gt;            &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;HttpServerProtocol&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;make_tls_context&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-39" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-39" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-39"&gt;&lt;/a&gt;            &lt;span class="n"&gt;server_side&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-40" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-40" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-40"&gt;&lt;/a&gt;        &lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-41" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-41" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-41"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-42" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-42" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-42"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;connect_received&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-43" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-43" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-43"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_over_tls&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;True&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-44" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-44" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-44"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_tls_proto&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;connection_made&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_transport&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-45" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-45" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-45"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-46" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-46" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-46"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;request_received&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-47" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-47" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-47"&gt;&lt;/a&gt;        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_http_parser&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_method&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s1"&gt;'CONNECT'&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-48" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-48" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-48"&gt;&lt;/a&gt;            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_transport&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;'HTTP/1.1 200 OK&lt;/span&gt;&lt;span class="se"&gt;\r\n\r\n&lt;/span&gt;&lt;span class="s1"&gt;'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-49" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-49" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-49"&gt;&lt;/a&gt;            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;connect_received&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-50" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-50" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-50"&gt;&lt;/a&gt;        &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-51" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-51" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-51"&gt;&lt;/a&gt;            &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;request_received&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-52" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-52" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-52"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-53" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-53" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-53"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;data_received&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="nb"&gt;bytes&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-54" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-54" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-54"&gt;&lt;/a&gt;        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_over_tls&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-55" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-55" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-55"&gt;&lt;/a&gt;            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_tls_proto&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;data_received&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-56" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-56" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-56"&gt;&lt;/a&gt;        &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-57" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-57" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-57"&gt;&lt;/a&gt;            &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;data_received&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-58" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-58" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-58"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-59" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-59" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-59"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-60" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-60" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-60"&gt;&lt;/a&gt;&lt;span class="k"&gt;async&lt;/span&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;start_server&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-61" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-61" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-61"&gt;&lt;/a&gt;    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;create_server&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-62" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-62" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-62"&gt;&lt;/a&gt;        &lt;span class="k"&gt;lambda&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;HttpsServerProtocol&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="s1"&gt;'0.0.0.0'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;8082&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;backlog&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;65535&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-63" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-63" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-63"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-64" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-64" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-64"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-65" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-65" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-65"&gt;&lt;/a&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;make_tls_context&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-66" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-66" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-66"&gt;&lt;/a&gt;    &lt;span class="n"&gt;ctx&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ssl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SSLContext&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ssl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;PROTOCOL_SSLv23&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-67" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-67" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-67"&gt;&lt;/a&gt;    &lt;span class="n"&gt;ctx&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;load_cert_chain&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'example.com.crt'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'https.key.pem'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-68" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-68" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-68"&gt;&lt;/a&gt;    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ctx&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-69" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-69" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-69"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-70" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-70" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-70"&gt;&lt;/a&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-71" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-71" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-71"&gt;&lt;/a&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;main&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-72" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-72" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-72"&gt;&lt;/a&gt;    &lt;span class="n"&gt;loop&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;asyncio&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;new_event_loop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-73" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-73" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-73"&gt;&lt;/a&gt;    &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;run_until_complete&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;start_server&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-74" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-74" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-74"&gt;&lt;/a&gt;    &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;run_forever&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-75" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-75" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/#rest_code_f0145e3ac88e4d0f8f595df2545a6867-75"&gt;&lt;/a&gt;    &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Initially I have &lt;cite&gt;HttpServerProtocol&lt;/cite&gt; which receives data stream, parses
HTTP messages and calls &lt;cite&gt;request_received&lt;/cite&gt; which returns just a dummy response:&lt;/p&gt;
&lt;pre class="literal-block"&gt;  ~ curl http://localhost:8082/any/path -v
&amp;gt; GET /any/path HTTP/1.1
&amp;gt; User-Agent: curl/7.38.0
&amp;gt; Host: localhost:8082
&amp;gt; Accept: */*
&amp;gt;
&amp;lt; HTTP/1.1 200 OK
&amp;lt; Content-Length: 2
&amp;lt; Connection: close
&amp;lt;

OK&lt;/pre&gt;
&lt;p&gt;Then I have &lt;cite&gt;HttpsServerProtocol&lt;/cite&gt; which is just the extension of
&lt;cite&gt;HttpServerProtocol&lt;/cite&gt; but also is capable of upgrading connection to TLS.
The way it works is, it overrides &lt;cite&gt;request_received()&lt;/cite&gt; method which
checks if HTTP request is &lt;cite&gt;CONNECT&lt;/cite&gt;.
If it is, &lt;cite&gt;HttpsServerProtocol&lt;/cite&gt; tells &lt;cite&gt;SSLProtocol&lt;/cite&gt; to handle a new connection:&lt;/p&gt;
&lt;pre class="literal-block"&gt;def connect_received(self) -&amp;gt; None:
    self._over_tls = True
    self._tls_proto.connection_made(self._transport)&lt;/pre&gt;
&lt;p&gt;Then &lt;cite&gt;SSLProtocol&lt;/cite&gt; does the TLS handshake and data encryption/decryption:&lt;/p&gt;
&lt;pre class="literal-block"&gt;  ~ curl --proxy localhost:8082 https://dummy.org -k -v
&amp;gt; CONNECT dummy.org:443 HTTP/1.1
&amp;gt; Host: dummy.org:443
&amp;gt; User-Agent: curl/7.38.0
&amp;gt; Proxy-Connection: Keep-Alive
&amp;gt;
&amp;lt; HTTP/1.1 200 OK
&amp;lt;
* Proxy replied OK to CONNECT request
* successfully set certificate verify locations:
*   CAfile: none
  CApath: /etc/ssl/certs
* SSLv3, TLS handshake, Client hello (1):
* SSLv3, TLS handshake, Server hello (2):
* SSLv3, TLS handshake, CERT (11):
* SSLv3, TLS handshake, Server key exchange (12):
* SSLv3, TLS handshake, Server finished (14):
* SSLv3, TLS handshake, Client key exchange (16):
* SSLv3, TLS change cipher, Client hello (1):
* SSLv3, TLS handshake, Finished (20):
* SSLv3, TLS change cipher, Client hello (1):
* SSLv3, TLS handshake, Finished (20):
* SSL connection using TLSv1.2 / ECDHE-RSA-AES256-GCM-SHA384
* Server certificate:
*        subject: CN=dummy.org
*        start date: 2017-02-02 08:28:42 GMT
*        expire date: 2017-02-02 08:28:42 GMT
*        issuer: CN=development ca
*        SSL certificate verify result: unable to get local issuer certificate (20), continuing anyway.
&amp;gt; GET / HTTP/1.1
&amp;gt; User-Agent: curl/7.38.0
&amp;gt; Host: dummy.org
&amp;gt; Accept: */*
&amp;gt;
&amp;lt; HTTP/1.1 200 OK
&amp;lt; Content-Length: 2
&amp;lt; Connection: close
&amp;lt;
OK&lt;/pre&gt;
&lt;p&gt;When &lt;cite&gt;SSLProtocol&lt;/cite&gt; receives some data, it decrypts it and passes to
&lt;cite&gt;HttpServerProtocol.data_received()&lt;/cite&gt;.
And from now on we're communicating over TLS.&lt;/p&gt;</description><category>asyncio</category><category>python3</category><category>ssl</category><category>starttls</category><category>tls</category><guid>http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/</guid><pubDate>Mon, 20 Feb 2017 05:40:47 GMT</pubDate></item><item><title>Async write to stdout slower than print?</title><link>http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/</link><dc:creator>Povilas Balciunas</dc:creator><description>&lt;p&gt;While implementing HTTP benchmarking tool with asyncio, I was playing with
asyncronous writes to stdout - aka async print.
My motivation was to improve performance of course :).&lt;/p&gt;
&lt;p&gt;But after running some small benchmarks:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code python"&gt;&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-1" name="rest_code_fb491cc2348e49f081df78dea51788ff-1" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-1"&gt;&lt;/a&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;asyncio&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-2" name="rest_code_fb491cc2348e49f081df78dea51788ff-2" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-2"&gt;&lt;/a&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;os&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-3" name="rest_code_fb491cc2348e49f081df78dea51788ff-3" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-3"&gt;&lt;/a&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;time&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-4" name="rest_code_fb491cc2348e49f081df78dea51788ff-4" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-4"&gt;&lt;/a&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-5" name="rest_code_fb491cc2348e49f081df78dea51788ff-5" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-5"&gt;&lt;/a&gt;&lt;span class="k"&gt;async&lt;/span&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;make_stdout&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-6" name="rest_code_fb491cc2348e49f081df78dea51788ff-6" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-6"&gt;&lt;/a&gt;    &lt;span class="n"&gt;writer_transport&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;writer_protocol&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;connect_write_pipe&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-7" name="rest_code_fb491cc2348e49f081df78dea51788ff-7" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-7"&gt;&lt;/a&gt;        &lt;span class="n"&gt;FlowControlMixin&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fdopen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'wb'&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-8" name="rest_code_fb491cc2348e49f081df78dea51788ff-8" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-8"&gt;&lt;/a&gt;    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;asyncio&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;StreamWriter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;writer_transport&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;writer_protocol&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-9" name="rest_code_fb491cc2348e49f081df78dea51788ff-9" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-9"&gt;&lt;/a&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-10" name="rest_code_fb491cc2348e49f081df78dea51788ff-10" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-10"&gt;&lt;/a&gt;&lt;span class="k"&gt;async&lt;/span&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;do_async_print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-11" name="rest_code_fb491cc2348e49f081df78dea51788ff-11" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-11"&gt;&lt;/a&gt;    &lt;span class="n"&gt;stdout&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="n"&gt;make_stdout&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-12" name="rest_code_fb491cc2348e49f081df78dea51788ff-12" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-12"&gt;&lt;/a&gt;    &lt;span class="n"&gt;started&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-13" name="rest_code_fb491cc2348e49f081df78dea51788ff-13" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-13"&gt;&lt;/a&gt;    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;_&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;4000&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-14" name="rest_code_fb491cc2348e49f081df78dea51788ff-14" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-14"&gt;&lt;/a&gt;        &lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;b&lt;/span&gt;&lt;span class="s1"&gt;'works works works works works works works works works works&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s1"&gt;'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-15" name="rest_code_fb491cc2348e49f081df78dea51788ff-15" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-15"&gt;&lt;/a&gt;    &lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;bytes&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'Time taken: &lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s1"&gt;'&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;started&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="s1"&gt;'ascii'&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-16" name="rest_code_fb491cc2348e49f081df78dea51788ff-16" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-16"&gt;&lt;/a&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-17" name="rest_code_fb491cc2348e49f081df78dea51788ff-17" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-17"&gt;&lt;/a&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test_async_print&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-18" name="rest_code_fb491cc2348e49f081df78dea51788ff-18" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-18"&gt;&lt;/a&gt;    &lt;span class="n"&gt;loop&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;asyncio&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_event_loop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-19" name="rest_code_fb491cc2348e49f081df78dea51788ff-19" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-19"&gt;&lt;/a&gt;    &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;run_until_complete&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;do_async_print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-20" name="rest_code_fb491cc2348e49f081df78dea51788ff-20" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-20"&gt;&lt;/a&gt;    &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-21" name="rest_code_fb491cc2348e49f081df78dea51788ff-21" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-21"&gt;&lt;/a&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-22" name="rest_code_fb491cc2348e49f081df78dea51788ff-22" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-22"&gt;&lt;/a&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test_sync_print&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-23" name="rest_code_fb491cc2348e49f081df78dea51788ff-23" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-23"&gt;&lt;/a&gt;    &lt;span class="n"&gt;started&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-24" name="rest_code_fb491cc2348e49f081df78dea51788ff-24" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-24"&gt;&lt;/a&gt;    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;_&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;4000&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-25" name="rest_code_fb491cc2348e49f081df78dea51788ff-25" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-25"&gt;&lt;/a&gt;        &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'works works works works works works works works works works'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_fb491cc2348e49f081df78dea51788ff-26" name="rest_code_fb491cc2348e49f081df78dea51788ff-26" href="http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/#rest_code_fb491cc2348e49f081df78dea51788ff-26"&gt;&lt;/a&gt;    &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'Time taken:'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;started&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Turns out that &lt;cite&gt;test_sync_print()&lt;/cite&gt; runs quite faster than &lt;cite&gt;test_async_print()&lt;/cite&gt;.
In average 4000 sync prints run in &lt;strong&gt;100 ms&lt;/strong&gt;, whereas async print in &lt;strong&gt;150
ms&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Also, if I go beyond 4000 prints asynchronous method blocks for unknown reasons.
Synchronous works as expected.&lt;/p&gt;</description><category>asyncio</category><category>python</category><guid>http://blog.povilasb.com/posts/async-write-to-stdout-slower-than-print/</guid><pubDate>Wed, 04 Jan 2017 19:16:55 GMT</pubDate></item><item><title>Running Python async function</title><link>http://blog.povilasb.com/posts/running-python-async-function/</link><dc:creator>Povilas Balciunas</dc:creator><description>&lt;p&gt;Lately I was playing with asyncio and
&lt;a class="reference external" href="https://github.com/KeepSafe/aiohttp"&gt;aiohttp&lt;/a&gt; in python 3.5.2.
First time I hit the wall was when I was trying to test async methods:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code python"&gt;&lt;a id="rest_code_ff82525011984dd0b4423977207155e5-1" name="rest_code_ff82525011984dd0b4423977207155e5-1" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_ff82525011984dd0b4423977207155e5-1"&gt;&lt;/a&gt;&lt;span class="k"&gt;async&lt;/span&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;say_hi&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
&lt;a id="rest_code_ff82525011984dd0b4423977207155e5-2" name="rest_code_ff82525011984dd0b4423977207155e5-2" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_ff82525011984dd0b4423977207155e5-2"&gt;&lt;/a&gt;    &lt;span class="nb"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'Hi!'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;First of all I did not know how to call &lt;cite&gt;say_hi()&lt;/cite&gt; directly without event loop.
Reading &lt;a class="reference external" href="https://docs.python.org/3/library/asyncio-task.html"&gt;docs&lt;/a&gt; didn't
really help me.
I already knew I could do:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code python"&gt;&lt;a id="rest_code_5fbfdd1d1a1d49fb842ac6a640b86f84-1" name="rest_code_5fbfdd1d1a1d49fb842ac6a640b86f84-1" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_5fbfdd1d1a1d49fb842ac6a640b86f84-1"&gt;&lt;/a&gt;&lt;span class="n"&gt;loop&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;asyncio&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_event_loop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_5fbfdd1d1a1d49fb842ac6a640b86f84-2" name="rest_code_5fbfdd1d1a1d49fb842ac6a640b86f84-2" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_5fbfdd1d1a1d49fb842ac6a640b86f84-2"&gt;&lt;/a&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;run_until_complete&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;say_hi&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;a id="rest_code_5fbfdd1d1a1d49fb842ac6a640b86f84-3" name="rest_code_5fbfdd1d1a1d49fb842ac6a640b86f84-3" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_5fbfdd1d1a1d49fb842ac6a640b86f84-3"&gt;&lt;/a&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;But I was more interested how asyncio event loop triggers this method by
itself.
So I decided to dig into asyncio source code.&lt;/p&gt;
&lt;section id="summary"&gt;
&lt;h2&gt;Summary&lt;/h2&gt;
&lt;p&gt;I've found two ways to call async &lt;cite&gt;say_hi()&lt;/cite&gt; without event loop.&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;p&gt;Send something to coroutine:&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="code"&gt;&lt;pre class="code python"&gt;&lt;a id="rest_code_623ca78c162a4f6baa227ebfc4f00fce-1" name="rest_code_623ca78c162a4f6baa227ebfc4f00fce-1" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_623ca78c162a4f6baa227ebfc4f00fce-1"&gt;&lt;/a&gt;&lt;span class="n"&gt;cor&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;say_hi&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_623ca78c162a4f6baa227ebfc4f00fce-2" name="rest_code_623ca78c162a4f6baa227ebfc4f00fce-2" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_623ca78c162a4f6baa227ebfc4f00fce-2"&gt;&lt;/a&gt;&lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_623ca78c162a4f6baa227ebfc4f00fce-3" name="rest_code_623ca78c162a4f6baa227ebfc4f00fce-3" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_623ca78c162a4f6baa227ebfc4f00fce-3"&gt;&lt;/a&gt;    &lt;span class="n"&gt;cor&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;send&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_623ca78c162a4f6baa227ebfc4f00fce-4" name="rest_code_623ca78c162a4f6baa227ebfc4f00fce-4" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_623ca78c162a4f6baa227ebfc4f00fce-4"&gt;&lt;/a&gt;&lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;StopIteration&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_623ca78c162a4f6baa227ebfc4f00fce-5" name="rest_code_623ca78c162a4f6baa227ebfc4f00fce-5" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_623ca78c162a4f6baa227ebfc4f00fce-5"&gt;&lt;/a&gt;    &lt;span class="k"&gt;pass&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;ol class="arabic simple" start="2"&gt;
&lt;li&gt;&lt;p&gt;Wrap coroutine in Future:&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="code"&gt;&lt;pre class="code python"&gt;&lt;a id="rest_code_be8b180d11fc4a8fba324aa5cc5f8e02-1" name="rest_code_be8b180d11fc4a8fba324aa5cc5f8e02-1" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_be8b180d11fc4a8fba324aa5cc5f8e02-1"&gt;&lt;/a&gt;&lt;span class="n"&gt;future&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;asyncio&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ensure_future&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;say_hi&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;
&lt;a id="rest_code_be8b180d11fc4a8fba324aa5cc5f8e02-2" name="rest_code_be8b180d11fc4a8fba324aa5cc5f8e02-2" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_be8b180d11fc4a8fba324aa5cc5f8e02-2"&gt;&lt;/a&gt;&lt;span class="n"&gt;future&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_step&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/section&gt;
&lt;section id="baseeventloop"&gt;
&lt;h2&gt;BaseEventLoop&lt;/h2&gt;
&lt;p&gt;Turns out on Debian &lt;cite&gt;asyncio.get_event_loop()&lt;/cite&gt; returns &lt;cite&gt;UnixSelectEventLoop&lt;/cite&gt;.
It extends some other event loops:&lt;/p&gt;
&lt;pre class="literal-block"&gt;UnixSelectEventLoop --&amp;gt; BaseSelectorEventLoop --&amp;gt; BaseEventLoop --&amp;gt; AbstractEventLoop&lt;/pre&gt;
&lt;p&gt;&lt;cite&gt;BaseEventLoop&lt;/cite&gt; is the one that interests me, because it implements
&lt;cite&gt;run_until_complete()&lt;/cite&gt; method.&lt;/p&gt;
&lt;p&gt;&lt;cite&gt;run_until_complete()&lt;/cite&gt; calls &lt;cite&gt;self.run_forever()&lt;/cite&gt; which calls
&lt;cite&gt;self._run_once()&lt;/cite&gt;.&lt;/p&gt;
&lt;p&gt;What &lt;cite&gt;_run_once()&lt;/cite&gt; essentially does is it gets the handle from the task queue
and calls &lt;cite&gt;handle._run()&lt;/cite&gt;:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code python"&gt;&lt;a id="rest_code_84dd1650973447d49555a4636b223557-1" name="rest_code_84dd1650973447d49555a4636b223557-1" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_84dd1650973447d49555a4636b223557-1"&gt;&lt;/a&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;BaseEventLoop&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;events&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;AbstractEventLoop&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_84dd1650973447d49555a4636b223557-2" name="rest_code_84dd1650973447d49555a4636b223557-2" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_84dd1650973447d49555a4636b223557-2"&gt;&lt;/a&gt;
&lt;a id="rest_code_84dd1650973447d49555a4636b223557-3" name="rest_code_84dd1650973447d49555a4636b223557-3" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_84dd1650973447d49555a4636b223557-3"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_84dd1650973447d49555a4636b223557-4" name="rest_code_84dd1650973447d49555a4636b223557-4" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_84dd1650973447d49555a4636b223557-4"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_ready&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;collections&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;deque&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_84dd1650973447d49555a4636b223557-5" name="rest_code_84dd1650973447d49555a4636b223557-5" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_84dd1650973447d49555a4636b223557-5"&gt;&lt;/a&gt;
&lt;a id="rest_code_84dd1650973447d49555a4636b223557-6" name="rest_code_84dd1650973447d49555a4636b223557-6" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_84dd1650973447d49555a4636b223557-6"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;_run_once&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_84dd1650973447d49555a4636b223557-7" name="rest_code_84dd1650973447d49555a4636b223557-7" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_84dd1650973447d49555a4636b223557-7"&gt;&lt;/a&gt;        &lt;span class="n"&gt;handle&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_ready&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;popleft&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_84dd1650973447d49555a4636b223557-8" name="rest_code_84dd1650973447d49555a4636b223557-8" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_84dd1650973447d49555a4636b223557-8"&gt;&lt;/a&gt;        &lt;span class="n"&gt;handle&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_run&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;cite&gt;handle&lt;/cite&gt; type is &lt;cite&gt;asyncio.events.Handle&lt;/cite&gt;. It's simplified version is:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code python"&gt;&lt;a id="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-1" name="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-1" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_702ca35f2b2d489ca5a634e5e493a4f7-1"&gt;&lt;/a&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Handle&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-2" name="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-2" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_702ca35f2b2d489ca5a634e5e493a4f7-2"&gt;&lt;/a&gt;    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-3" name="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-3" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_702ca35f2b2d489ca5a634e5e493a4f7-3"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_loop&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;loop&lt;/span&gt;
&lt;a id="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-4" name="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-4" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_702ca35f2b2d489ca5a634e5e493a4f7-4"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_callback&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;callback&lt;/span&gt;
&lt;a id="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-5" name="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-5" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_702ca35f2b2d489ca5a634e5e493a4f7-5"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_args&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;
&lt;a id="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-6" name="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-6" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_702ca35f2b2d489ca5a634e5e493a4f7-6"&gt;&lt;/a&gt;
&lt;a id="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-7" name="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-7" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_702ca35f2b2d489ca5a634e5e493a4f7-7"&gt;&lt;/a&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;_run&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-8" name="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-8" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_702ca35f2b2d489ca5a634e5e493a4f7-8"&gt;&lt;/a&gt;    &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-9" name="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-9" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_702ca35f2b2d489ca5a634e5e493a4f7-9"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_callback&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_args&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-10" name="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-10" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_702ca35f2b2d489ca5a634e5e493a4f7-10"&gt;&lt;/a&gt;    &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;Exception&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;exc&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-11" name="rest_code_702ca35f2b2d489ca5a634e5e493a4f7-11" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_702ca35f2b2d489ca5a634e5e493a4f7-11"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# ...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now this is where the call chain started from &lt;cite&gt;run_until_complete()&lt;/cite&gt; stops.
And it's clear to me that I have to find the spot where handles are created
and added to the &lt;cite&gt;event_loop._ready&lt;/cite&gt; queue (or dequeu to be precise).&lt;/p&gt;
&lt;/section&gt;
&lt;section id="how-my-async-function-is-turned-into-handle"&gt;
&lt;h2&gt;How my async function is turned into Handle?&lt;/h2&gt;
&lt;p&gt;Let's go back to &lt;cite&gt;loop.run_until_complete()&lt;/cite&gt;. Simplified version could be read
as:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code python"&gt;&lt;a id="rest_code_53ddad6a94d444489919cbf28ae0dc22-1" name="rest_code_53ddad6a94d444489919cbf28ae0dc22-1" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_53ddad6a94d444489919cbf28ae0dc22-1"&gt;&lt;/a&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;run_until_complete&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;future&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_53ddad6a94d444489919cbf28ae0dc22-2" name="rest_code_53ddad6a94d444489919cbf28ae0dc22-2" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_53ddad6a94d444489919cbf28ae0dc22-2"&gt;&lt;/a&gt;    &lt;span class="n"&gt;future&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;tasks&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ensure_future&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;future&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_53ddad6a94d444489919cbf28ae0dc22-3" name="rest_code_53ddad6a94d444489919cbf28ae0dc22-3" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_53ddad6a94d444489919cbf28ae0dc22-3"&gt;&lt;/a&gt;
&lt;a id="rest_code_53ddad6a94d444489919cbf28ae0dc22-4" name="rest_code_53ddad6a94d444489919cbf28ae0dc22-4" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_53ddad6a94d444489919cbf28ae0dc22-4"&gt;&lt;/a&gt;    &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_53ddad6a94d444489919cbf28ae0dc22-5" name="rest_code_53ddad6a94d444489919cbf28ae0dc22-5" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_53ddad6a94d444489919cbf28ae0dc22-5"&gt;&lt;/a&gt;        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;run_forever&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_53ddad6a94d444489919cbf28ae0dc22-6" name="rest_code_53ddad6a94d444489919cbf28ae0dc22-6" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_53ddad6a94d444489919cbf28ae0dc22-6"&gt;&lt;/a&gt;    &lt;span class="k"&gt;except&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_53ddad6a94d444489919cbf28ae0dc22-7" name="rest_code_53ddad6a94d444489919cbf28ae0dc22-7" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_53ddad6a94d444489919cbf28ae0dc22-7"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# ...&lt;/span&gt;
&lt;a id="rest_code_53ddad6a94d444489919cbf28ae0dc22-8" name="rest_code_53ddad6a94d444489919cbf28ae0dc22-8" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_53ddad6a94d444489919cbf28ae0dc22-8"&gt;&lt;/a&gt;    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;future&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Ok, let's investigate &lt;cite&gt;tasks.ensure_future()&lt;/cite&gt;. In my case it does:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code python"&gt;&lt;a id="rest_code_1e0c93f1cef14db7977b80ded7d8ac24-1" name="rest_code_1e0c93f1cef14db7977b80ded7d8ac24-1" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_1e0c93f1cef14db7977b80ded7d8ac24-1"&gt;&lt;/a&gt;&lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;create_task&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;coro_or_future&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Which by itself does not do a lot:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code python"&gt;&lt;a id="rest_code_6be0b0b27d894d8db246b9f090ed7f20-1" name="rest_code_6be0b0b27d894d8db246b9f090ed7f20-1" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_6be0b0b27d894d8db246b9f090ed7f20-1"&gt;&lt;/a&gt;&lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;tasks&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Task&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;coro&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;But &lt;cite&gt;Task&lt;/cite&gt; constructor calls something interesting:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code python"&gt;&lt;a id="rest_code_ec8c9c4cbbb14bb8a3b29ee6efdac559-1" name="rest_code_ec8c9c4cbbb14bb8a3b29ee6efdac559-1" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_ec8c9c4cbbb14bb8a3b29ee6efdac559-1"&gt;&lt;/a&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;coro&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_ec8c9c4cbbb14bb8a3b29ee6efdac559-2" name="rest_code_ec8c9c4cbbb14bb8a3b29ee6efdac559-2" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_ec8c9c4cbbb14bb8a3b29ee6efdac559-2"&gt;&lt;/a&gt;    &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_ec8c9c4cbbb14bb8a3b29ee6efdac559-3" name="rest_code_ec8c9c4cbbb14bb8a3b29ee6efdac559-3" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_ec8c9c4cbbb14bb8a3b29ee6efdac559-3"&gt;&lt;/a&gt;    &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_coro&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;coro&lt;/span&gt;
&lt;a id="rest_code_ec8c9c4cbbb14bb8a3b29ee6efdac559-4" name="rest_code_ec8c9c4cbbb14bb8a3b29ee6efdac559-4" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_ec8c9c4cbbb14bb8a3b29ee6efdac559-4"&gt;&lt;/a&gt;    &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;call_soon&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_step&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And &lt;cite&gt;Task._step()&lt;/cite&gt; method is even more interesting:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code python"&gt;&lt;a id="rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-1" name="rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-1" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-1"&gt;&lt;/a&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;_step&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;exc&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-2" name="rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-2" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-2"&gt;&lt;/a&gt;    &lt;span class="c1"&gt;# ...&lt;/span&gt;
&lt;a id="rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-3" name="rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-3" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-3"&gt;&lt;/a&gt;    &lt;span class="n"&gt;coro&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_coro&lt;/span&gt;
&lt;a id="rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-4" name="rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-4" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-4"&gt;&lt;/a&gt;    &lt;span class="c1"&gt;# ...&lt;/span&gt;
&lt;a id="rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-5" name="rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-5" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-5"&gt;&lt;/a&gt;    &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-6" name="rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-6" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-6"&gt;&lt;/a&gt;        &lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;coro&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;send&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-7" name="rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-7" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-7"&gt;&lt;/a&gt;    &lt;span class="k"&gt;except&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-8" name="rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-8" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-8"&gt;&lt;/a&gt;        &lt;span class="c1"&gt;# ...&lt;/span&gt;
&lt;a id="rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-9" name="rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-9" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_ef936be4a60c48dc97fa6d8a1f4bd22d-9"&gt;&lt;/a&gt;    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;AHA, seems like &lt;cite&gt;coro.send(None)&lt;/cite&gt; triggers the async function.
I quickly test it and indeed it works :) :&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code python"&gt;&lt;a id="rest_code_e78fcfbcd6004a5e8a35ab49f7899b60-1" name="rest_code_e78fcfbcd6004a5e8a35ab49f7899b60-1" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_e78fcfbcd6004a5e8a35ab49f7899b60-1"&gt;&lt;/a&gt;&lt;span class="n"&gt;say_hi&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;send&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kc"&gt;None&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Anyway, let's keep hunting how this coroutine (my async function) is turned
into Handle...&lt;/p&gt;
&lt;p&gt;The next interesting function in &lt;cite&gt;Task&lt;/cite&gt; contructor is &lt;cite&gt;loop.call_soon()&lt;/cite&gt;.
It simply calls &lt;cite&gt;self._call_soon()&lt;/cite&gt;.
Which does the rest:&lt;/p&gt;
&lt;div class="code"&gt;&lt;pre class="code python"&gt;&lt;a id="rest_code_6f8c87fcc09b415686a3818571b6ad2d-1" name="rest_code_6f8c87fcc09b415686a3818571b6ad2d-1" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_6f8c87fcc09b415686a3818571b6ad2d-1"&gt;&lt;/a&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;_call_soon&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a id="rest_code_6f8c87fcc09b415686a3818571b6ad2d-2" name="rest_code_6f8c87fcc09b415686a3818571b6ad2d-2" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_6f8c87fcc09b415686a3818571b6ad2d-2"&gt;&lt;/a&gt;    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;coroutines&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iscoroutine&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_6f8c87fcc09b415686a3818571b6ad2d-3" name="rest_code_6f8c87fcc09b415686a3818571b6ad2d-3" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_6f8c87fcc09b415686a3818571b6ad2d-3"&gt;&lt;/a&gt;    &lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="n"&gt;coroutines&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iscoroutinefunction&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;)):&lt;/span&gt;
&lt;a id="rest_code_6f8c87fcc09b415686a3818571b6ad2d-4" name="rest_code_6f8c87fcc09b415686a3818571b6ad2d-4" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_6f8c87fcc09b415686a3818571b6ad2d-4"&gt;&lt;/a&gt;        &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="ne"&gt;TypeError&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"coroutines cannot be used with call_soon()"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_6f8c87fcc09b415686a3818571b6ad2d-5" name="rest_code_6f8c87fcc09b415686a3818571b6ad2d-5" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_6f8c87fcc09b415686a3818571b6ad2d-5"&gt;&lt;/a&gt;    &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_check_closed&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;a id="rest_code_6f8c87fcc09b415686a3818571b6ad2d-6" name="rest_code_6f8c87fcc09b415686a3818571b6ad2d-6" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_6f8c87fcc09b415686a3818571b6ad2d-6"&gt;&lt;/a&gt;    &lt;span class="n"&gt;handle&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;events&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Handle&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_6f8c87fcc09b415686a3818571b6ad2d-7" name="rest_code_6f8c87fcc09b415686a3818571b6ad2d-7" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_6f8c87fcc09b415686a3818571b6ad2d-7"&gt;&lt;/a&gt;    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;handle&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_source_traceback&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;a id="rest_code_6f8c87fcc09b415686a3818571b6ad2d-8" name="rest_code_6f8c87fcc09b415686a3818571b6ad2d-8" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_6f8c87fcc09b415686a3818571b6ad2d-8"&gt;&lt;/a&gt;        &lt;span class="k"&gt;del&lt;/span&gt; &lt;span class="n"&gt;handle&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_source_traceback&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;a id="rest_code_6f8c87fcc09b415686a3818571b6ad2d-9" name="rest_code_6f8c87fcc09b415686a3818571b6ad2d-9" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_6f8c87fcc09b415686a3818571b6ad2d-9"&gt;&lt;/a&gt;    &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_ready&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;handle&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a id="rest_code_6f8c87fcc09b415686a3818571b6ad2d-10" name="rest_code_6f8c87fcc09b415686a3818571b6ad2d-10" href="http://blog.povilasb.com/posts/running-python-async-function/#rest_code_6f8c87fcc09b415686a3818571b6ad2d-10"&gt;&lt;/a&gt;    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;handle&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It wraps callback (our async function) into &lt;cite&gt;Handle&lt;/cite&gt; and appends it
to the &lt;cite&gt;loop._ready&lt;/cite&gt; queue.&lt;/p&gt;
&lt;p&gt;So the call graph is something like this:&lt;/p&gt;
&lt;pre class="literal-block"&gt;   loop.run_until_complete(future)
               |
               V
   tasks.ensure_future(future, loop)
               |
               V
      loop.create_task(future)
               |
               V
      task.Task(future, loop)
               |
               V
      loop.call_soon(task._step)
               |
               V
      loop._call_soon(task._step)
               |
               V
loop._ready.append(Handle(task._step))&lt;/pre&gt;
&lt;/section&gt;</description><category>asyncio</category><category>python3</category><guid>http://blog.povilasb.com/posts/running-python-async-function/</guid><pubDate>Wed, 14 Dec 2016 05:37:58 GMT</pubDate></item></channel></rss>