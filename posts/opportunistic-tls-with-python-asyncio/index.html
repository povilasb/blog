<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Opportunistic TLS with python asyncio | Povilas Blog</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Povilas Balciunas">
<link rel="prev" href="../python-ssl-memorybio-usage/" title="Python SSL MemoryBIO usage" type="text/html">
<link rel="next" href="../mnist-with-scikit-learn/" title="MNIST with scikit-learn" type="text/html">
<meta property="og:site_name" content="Povilas Blog">
<meta property="og:title" content="Opportunistic TLS with python asyncio">
<meta property="og:url" content="http://blog.povilasb.com/posts/opportunistic-tls-with-python-asyncio/">
<meta property="og:description" content="Recently I was implementing an HTTPS proxy that was doing a man in the middle
attack similar to what https://mitmproxy.org/ does.
This server upgrades TCP connection to TLS on HTTP CONNECT method.
Whi">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-02-20T07:40:47+02:00">
<meta property="article:tag" content="asyncio">
<meta property="article:tag" content="python3">
<meta property="article:tag" content="ssl">
<meta property="article:tag" content="starttls">
<meta property="article:tag" content="tls">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark
bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="../../">

            <span id="blog-title">Povilas Blog</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../archive.html" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="../../categories/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
<ul class="navbar-nav navbar-right">
<li class="nav-item">
    <a href="index.rst" id="sourcelink" class="nav-link">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Opportunistic TLS with python asyncio</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Povilas Balciunas
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2017-02-20T07:40:47+02:00" itemprop="datePublished" title="2017-02-20 07:40">2017-02-20 07:40</time></a>
            </p>
                <p class="commentline">    

                    </p>
<p class="sourceline"><a href="index.rst" class="sourcelink">Source</a></p>

        </div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>Recently I was implementing an HTTPS proxy that was doing a man in the middle
attack similar to what <a class="reference external" href="https://mitmproxy.org/">https://mitmproxy.org/</a> does.
This server upgrades TCP connection to TLS on <a class="reference external" href="https://en.wikipedia.org/wiki/HTTP_tunnel#HTTP_CONNECT_tunneling">HTTP CONNECT</a> method.
While researching how to do this with asyncio I came across this python
issue <a class="reference external" href="https://bugs.python.org/issue23749">https://bugs.python.org/issue23749</a>.</p>
<p>After reading the discussion it was clear that <cite>asyncio.sslproto.SSLProtocol</cite>
has TLS/SSL implementation.
Also Yury Selivanov posted a recent patch that allows us to wrap application
protocol inside <cite>SSLProtocol</cite>: <a class="reference external" href="https://hg.python.org/cpython/rev/3e6739e5c2d0">https://hg.python.org/cpython/rev/3e6739e5c2d0</a>.</p>
<p>Eventually, I ended up with a prototype:</p>
<div class="code"><pre class="code python"><a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-1" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-1" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-1"></a><span class="c1"># https://github.com/benoitc/http-parser/</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-2" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-2" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-2"></a><span class="kn">from</span> <span class="nn">http_parser.parser</span> <span class="kn">import</span> <span class="n">HttpParser</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-3" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-3" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-3"></a>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-4" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-4" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-4"></a>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-5" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-5" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-5"></a><span class="k">class</span> <span class="nc">HttpServerProtocol</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Protocol</span><span class="p">):</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-6" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-6" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-6"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-7" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-7" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-7"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-8" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-8" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_http_parser</span> <span class="o">=</span> <span class="n">HttpParser</span><span class="p">()</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-9" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-9" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span> <span class="o">=</span> <span class="kc">None</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-10" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-10" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-10"></a>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-11" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-11" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-11"></a>    <span class="k">def</span> <span class="nf">request_received</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-12" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-12" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-13" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-13" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-13"></a>            <span class="sa">b</span><span class="s1">'HTTP/1.1 200 OK</span><span class="se">\r\n</span><span class="s1">'</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-14" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-14" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-14"></a>            <span class="sa">b</span><span class="s1">'Content-Length: 2</span><span class="se">\r\n</span><span class="s1">'</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-15" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-15" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-15"></a>            <span class="sa">b</span><span class="s1">'Connection: close</span><span class="se">\r\n\r\n</span><span class="s1">'</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-16" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-16" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-16"></a>            <span class="sa">b</span><span class="s1">'OK'</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-17" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-17" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-17"></a>        <span class="p">)</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-18" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-18" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-19" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-19" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-19"></a>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-20" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-20" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-20"></a>    <span class="k">def</span> <span class="nf">data_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-21" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-21" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_http_parser</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-22" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-22" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-22"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_http_parser</span><span class="o">.</span><span class="n">is_message_complete</span><span class="p">():</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-23" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-23" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-23"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">request_received</span><span class="p">()</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-24" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-24" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-24"></a>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-25" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-25" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-25"></a>    <span class="k">def</span> <span class="nf">connection_made</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transport</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-26" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-26" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span> <span class="o">=</span> <span class="n">transport</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-27" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-27" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-27"></a>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-28" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-28" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-28"></a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-29" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-29" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-29"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-30" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-30" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-30"></a>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-31" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-31" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-31"></a>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-32" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-32" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-32"></a><span class="k">class</span> <span class="nc">HttpsServerProtocol</span><span class="p">(</span><span class="n">HttpServerProtocol</span><span class="p">):</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-33" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-33" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-33"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-34" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-34" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-34"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-35" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-35" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-35"></a>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-36" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-36" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-36"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_over_tls</span> <span class="o">=</span> <span class="kc">False</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-37" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-37" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tls_proto</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sslproto</span><span class="o">.</span><span class="n">SSLProtocol</span><span class="p">(</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-38" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-38" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-38"></a>            <span class="n">loop</span><span class="p">,</span> <span class="n">HttpServerProtocol</span><span class="p">(),</span> <span class="n">make_tls_context</span><span class="p">(),</span> <span class="kc">None</span><span class="p">,</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-39" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-39" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-39"></a>            <span class="n">server_side</span><span class="o">=</span><span class="kc">True</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-40" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-40" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-40"></a>        <span class="p">)</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-41" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-41" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-41"></a>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-42" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-42" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-42"></a>    <span class="k">def</span> <span class="nf">connect_received</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-43" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-43" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_over_tls</span> <span class="o">=</span> <span class="kc">True</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-44" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-44" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-44"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tls_proto</span><span class="o">.</span><span class="n">connection_made</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transport</span><span class="p">)</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-45" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-45" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-45"></a>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-46" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-46" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-46"></a>    <span class="k">def</span> <span class="nf">request_received</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-47" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-47" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-47"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_http_parser</span><span class="o">.</span><span class="n">get_method</span><span class="p">()</span> <span class="o">==</span> <span class="s1">'CONNECT'</span><span class="p">:</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-48" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-48" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-48"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">'HTTP/1.1 200 OK</span><span class="se">\r\n\r\n</span><span class="s1">'</span><span class="p">)</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-49" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-49" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-49"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">connect_received</span><span class="p">()</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-50" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-50" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-50"></a>        <span class="k">else</span><span class="p">:</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-51" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-51" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-51"></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">request_received</span><span class="p">()</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-52" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-52" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-52"></a>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-53" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-53" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-53"></a>    <span class="k">def</span> <span class="nf">data_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-54" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-54" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-54"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_over_tls</span><span class="p">:</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-55" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-55" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-55"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_tls_proto</span><span class="o">.</span><span class="n">data_received</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-56" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-56" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-56"></a>        <span class="k">else</span><span class="p">:</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-57" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-57" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-57"></a>            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">data_received</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-58" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-58" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-58"></a>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-59" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-59" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-59"></a>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-60" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-60" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-60"></a><span class="k">async</span> <span class="k">def</span> <span class="nf">start_server</span><span class="p">(</span><span class="n">loop</span><span class="p">):</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-61" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-61" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-61"></a>    <span class="k">return</span> <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_server</span><span class="p">(</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-62" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-62" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-62"></a>        <span class="k">lambda</span><span class="p">:</span> <span class="n">HttpsServerProtocol</span><span class="p">(</span><span class="n">loop</span><span class="p">),</span> <span class="s1">'0.0.0.0'</span><span class="p">,</span> <span class="mi">8082</span><span class="p">,</span> <span class="n">backlog</span><span class="o">=</span><span class="mi">65535</span><span class="p">)</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-63" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-63" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-63"></a>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-64" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-64" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-64"></a>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-65" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-65" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-65"></a><span class="k">def</span> <span class="nf">make_tls_context</span><span class="p">():</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-66" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-66" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-66"></a>    <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-67" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-67" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-67"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="s1">'example.com.crt'</span><span class="p">,</span> <span class="s1">'https.key.pem'</span><span class="p">)</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-68" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-68" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-68"></a>    <span class="k">return</span> <span class="n">ctx</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-69" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-69" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-69"></a>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-70" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-70" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-70"></a>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-71" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-71" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-71"></a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-72" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-72" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-72"></a>    <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-73" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-73" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-73"></a>    <span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">start_server</span><span class="p">(</span><span class="n">loop</span><span class="p">))</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-74" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-74" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-74"></a>    <span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">()</span>
<a id="rest_code_f0145e3ac88e4d0f8f595df2545a6867-75" name="rest_code_f0145e3ac88e4d0f8f595df2545a6867-75" href="#rest_code_f0145e3ac88e4d0f8f595df2545a6867-75"></a>    <span class="n">loop</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
<p>Initially I have <cite>HttpServerProtocol</cite> which receives data stream, parses
HTTP messages and calls <cite>request_received</cite> which returns just a dummy response:</p>
<pre class="literal-block">➜  ~ curl http://localhost:8082/any/path -v
&gt; GET /any/path HTTP/1.1
&gt; User-Agent: curl/7.38.0
&gt; Host: localhost:8082
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200 OK
&lt; Content-Length: 2
&lt; Connection: close
&lt;

OK</pre>
<p>Then I have <cite>HttpsServerProtocol</cite> which is just the extension of
<cite>HttpServerProtocol</cite> but also is capable of upgrading connection to TLS.
The way it works is, it overrides <cite>request_received()</cite> method which
checks if HTTP request is <cite>CONNECT</cite>.
If it is, <cite>HttpsServerProtocol</cite> tells <cite>SSLProtocol</cite> to handle a new connection:</p>
<pre class="literal-block">def connect_received(self) -&gt; None:
    self._over_tls = True
    self._tls_proto.connection_made(self._transport)</pre>
<p>Then <cite>SSLProtocol</cite> does the TLS handshake and data encryption/decryption:</p>
<pre class="literal-block">➜  ~ curl --proxy localhost:8082 https://dummy.org -k -v
&gt; CONNECT dummy.org:443 HTTP/1.1
&gt; Host: dummy.org:443
&gt; User-Agent: curl/7.38.0
&gt; Proxy-Connection: Keep-Alive
&gt;
&lt; HTTP/1.1 200 OK
&lt;
* Proxy replied OK to CONNECT request
* successfully set certificate verify locations:
*   CAfile: none
  CApath: /etc/ssl/certs
* SSLv3, TLS handshake, Client hello (1):
* SSLv3, TLS handshake, Server hello (2):
* SSLv3, TLS handshake, CERT (11):
* SSLv3, TLS handshake, Server key exchange (12):
* SSLv3, TLS handshake, Server finished (14):
* SSLv3, TLS handshake, Client key exchange (16):
* SSLv3, TLS change cipher, Client hello (1):
* SSLv3, TLS handshake, Finished (20):
* SSLv3, TLS change cipher, Client hello (1):
* SSLv3, TLS handshake, Finished (20):
* SSL connection using TLSv1.2 / ECDHE-RSA-AES256-GCM-SHA384
* Server certificate:
*        subject: CN=dummy.org
*        start date: 2017-02-02 08:28:42 GMT
*        expire date: 2017-02-02 08:28:42 GMT
*        issuer: CN=development ca
*        SSL certificate verify result: unable to get local issuer certificate (20), continuing anyway.
&gt; GET / HTTP/1.1
&gt; User-Agent: curl/7.38.0
&gt; Host: dummy.org
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200 OK
&lt; Content-Length: 2
&lt; Connection: close
&lt;
OK</pre>
<p>When <cite>SSLProtocol</cite> receives some data, it decrypts it and passes to
<cite>HttpServerProtocol.data_received()</cite>.
And from now on we're communicating over TLS.</p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/asyncio/" rel="tag">asyncio</a></li>
            <li><a class="tag p-category" href="../../categories/python3/" rel="tag">python3</a></li>
            <li><a class="tag p-category" href="../../categories/ssl/" rel="tag">ssl</a></li>
            <li><a class="tag p-category" href="../../categories/starttls/" rel="tag">starttls</a></li>
            <li><a class="tag p-category" href="../../categories/tls/" rel="tag">tls</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../python-ssl-memorybio-usage/" rel="prev" title="Python SSL MemoryBIO usage">Previous post</a>
            </li>
            <li class="next">
                <a href="../mnist-with-scikit-learn/" rel="next" title="MNIST with scikit-learn">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
            

        </section></article><!--End of body content--><footer id="footer">
            Contents © 2022         <a href="mailto:balciunas90@gmail.com">Povilas Balciunas</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>

        <script src="../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
