<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Samples how to use ssl.MemoryBIO introduced in python 3.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Python SSL MemoryBIO usage | Povilas Blog</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="http://blog.povilasb.com/posts/python-ssl-memorybio-usage/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Povilas Balciunas">
<link rel="prev" href="../async-write-to-stdout-slower-than-print/" title="Async write to stdout slower than print?" type="text/html">
<link rel="next" href="../opportunistic-tls-with-python-asyncio/" title="Opportunistic TLS with python asyncio" type="text/html">
<meta property="og:site_name" content="Povilas Blog">
<meta property="og:title" content="Python SSL MemoryBIO usage">
<meta property="og:url" content="http://blog.povilasb.com/posts/python-ssl-memorybio-usage/">
<meta property="og:description" content="Samples how to use ssl.MemoryBIO introduced in python 3.">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2017-02-07T18:47:23+02:00">
<meta property="article:tag" content="python">
<meta property="article:tag" content="python3">
<meta property="article:tag" content="ssl">
<meta property="article:tag" content="tls">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark
bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="../../">

            <span id="blog-title">Povilas Blog</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../archive.html" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="../../categories/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
<ul class="navbar-nav navbar-right">
<li class="nav-item">
    <a href="index.rst" id="sourcelink" class="nav-link">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Python SSL MemoryBIO usage</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Povilas Balciunas
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2017-02-07T18:47:23+02:00" itemprop="datePublished" title="2017-02-07 18:47">2017-02-07 18:47</time></a>
            </p>
                <p class="commentline">    

                    </p>
<p class="sourceline"><a href="index.rst" class="sourcelink">Source</a></p>

        </div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>OpenSSL has a basic I/O abstraction which is abbreviated as BIO.</p>
<p>This abstraction let's you encode raw stream to TLS and back in memory -
without actually doing any network I/O.</p>
<p>Python 3.5 introduced an API to use this feature:
<a class="reference external" href="https://docs.python.org/3/library/ssl.html#memory-bio-support">https://docs.python.org/3/library/ssl.html#memory-bio-support</a>.</p>
<p>I haven't found any samples/tutorials how to use these objects, so I'm
going to describe it briefly.</p>
<p><a class="reference external" href="https://docs.python.org/3/library/ssl.html#ssl.SSLObject">SSLObject</a> and
<a class="reference external" href="https://docs.python.org/3/library/ssl.html#ssl.MemoryBIO">MemoryBIO</a> are
the core objects to do TLS.
<cite>SSLObject</cite> does the data encryption/decryption and <cite>MemoryBIO</cite> objects
are used to feed data to <cite>SSLObject</cite> and receive it back.</p>
<p>The only way to create <cite>SSLObject</cite> is to use
<a class="reference external" href="https://docs.python.org/3/library/ssl.html#ssl.SSLContext.wrap_bio">SSLContext.wrap_bio()</a>.</p>
<div class="code"><pre class="code python"><a id="rest_code_9dfea63c8e0a48aca954f7bbe62ad436-1" name="rest_code_9dfea63c8e0a48aca954f7bbe62ad436-1" href="#rest_code_9dfea63c8e0a48aca954f7bbe62ad436-1"></a><span class="kn">import</span> <span class="nn">ssl</span>
<a id="rest_code_9dfea63c8e0a48aca954f7bbe62ad436-2" name="rest_code_9dfea63c8e0a48aca954f7bbe62ad436-2" href="#rest_code_9dfea63c8e0a48aca954f7bbe62ad436-2"></a>
<a id="rest_code_9dfea63c8e0a48aca954f7bbe62ad436-3" name="rest_code_9dfea63c8e0a48aca954f7bbe62ad436-3" href="#rest_code_9dfea63c8e0a48aca954f7bbe62ad436-3"></a><span class="n">tls_in_buff</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">MemoryBIO</span><span class="p">()</span>
<a id="rest_code_9dfea63c8e0a48aca954f7bbe62ad436-4" name="rest_code_9dfea63c8e0a48aca954f7bbe62ad436-4" href="#rest_code_9dfea63c8e0a48aca954f7bbe62ad436-4"></a><span class="n">tls_out_buff</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">MemoryBIO</span><span class="p">()</span>
<a id="rest_code_9dfea63c8e0a48aca954f7bbe62ad436-5" name="rest_code_9dfea63c8e0a48aca954f7bbe62ad436-5" href="#rest_code_9dfea63c8e0a48aca954f7bbe62ad436-5"></a>
<a id="rest_code_9dfea63c8e0a48aca954f7bbe62ad436-6" name="rest_code_9dfea63c8e0a48aca954f7bbe62ad436-6" href="#rest_code_9dfea63c8e0a48aca954f7bbe62ad436-6"></a><span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
<a id="rest_code_9dfea63c8e0a48aca954f7bbe62ad436-7" name="rest_code_9dfea63c8e0a48aca954f7bbe62ad436-7" href="#rest_code_9dfea63c8e0a48aca954f7bbe62ad436-7"></a><span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="s1">'localhost.crt'</span><span class="p">,</span> <span class="s1">'private_key.pem'</span><span class="p">)</span>
<a id="rest_code_9dfea63c8e0a48aca954f7bbe62ad436-8" name="rest_code_9dfea63c8e0a48aca954f7bbe62ad436-8" href="#rest_code_9dfea63c8e0a48aca954f7bbe62ad436-8"></a><span class="n">tls_obj</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">wrap_bio</span><span class="p">(</span><span class="n">tls_in_buff</span><span class="p">,</span> <span class="n">tls_out_buff</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
<p>To decrypt data we write it into input <cite>MemoryBIO</cite> object and then read
the raw data from <cite>SSLObject</cite>:</p>
<div class="code"><pre class="code python"><a id="rest_code_39fd1679073a43a9bec35a69605b7445-1" name="rest_code_39fd1679073a43a9bec35a69605b7445-1" href="#rest_code_39fd1679073a43a9bec35a69605b7445-1"></a><span class="n">tls_in_buff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">))</span>
<a id="rest_code_39fd1679073a43a9bec35a69605b7445-2" name="rest_code_39fd1679073a43a9bec35a69605b7445-2" href="#rest_code_39fd1679073a43a9bec35a69605b7445-2"></a><span class="n">http_req</span> <span class="o">=</span> <span class="n">tls_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<a id="rest_code_39fd1679073a43a9bec35a69605b7445-3" name="rest_code_39fd1679073a43a9bec35a69605b7445-3" href="#rest_code_39fd1679073a43a9bec35a69605b7445-3"></a><span class="nb">print</span><span class="p">(</span><span class="n">http_req</span><span class="p">)</span>
</pre></div>
<p>To encrypt data we write into <cite>SSLObject</cite> and then read the encrypted data
from output <cite>MemoryBIO</cite>:</p>
<div class="code"><pre class="code python"><a id="rest_code_846e1cee8cf8471f88dbac47342f2bac-1" name="rest_code_846e1cee8cf8471f88dbac47342f2bac-1" href="#rest_code_846e1cee8cf8471f88dbac47342f2bac-1"></a><span class="n">tls_obj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">'HTTP/1.1 200 OK</span><span class="se">\r\n\r\n</span><span class="s1">'</span><span class="p">)</span>
<a id="rest_code_846e1cee8cf8471f88dbac47342f2bac-2" name="rest_code_846e1cee8cf8471f88dbac47342f2bac-2" href="#rest_code_846e1cee8cf8471f88dbac47342f2bac-2"></a><span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">tls_out_buff</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
<p>Basically encryption/decryption could be depicted as:</p>
<pre class="literal-block">     b'data'    b'\x17\x03\x03\x00\x1c\xc1...'
        |                  |
write() |                  | write()
        |                  v
        |             +-----------+
        |             |   input   |
        |             | MemoryBIO |
        |             +-----------+
        |                  |
        v                  v
     +-----------------------------+
     |                             |
     |          SSLObject          |
     |                             |
     +-----------------------------+
        |                 |
        |                 | read()
        v                 v
  +-----------+         b'data'
  |   output  |
  | MemoryBIO |
  +-----------+
       |
read() |
       V

b'\x17\x03\x03\x00\x1c\xc1...'</pre>
<section id="sample-https-server"><h2>Sample HTTPS Server</h2>
<div class="code"><table class="codetable">
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-1"><code data-line-number=" 1"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-1" name="rest_code_095f5aea8f354d988a71f02eb47a8651-1"></a><span class="kn">import</span> <span class="nn">socket</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-2"><code data-line-number=" 2"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-2" name="rest_code_095f5aea8f354d988a71f02eb47a8651-2"></a><span class="kn">import</span> <span class="nn">ssl</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-3"><code data-line-number=" 3"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-3" name="rest_code_095f5aea8f354d988a71f02eb47a8651-3"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-4"><code data-line-number=" 4"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-4" name="rest_code_095f5aea8f354d988a71f02eb47a8651-4"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-5"><code data-line-number=" 5"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-5" name="rest_code_095f5aea8f354d988a71f02eb47a8651-5"></a><span class="k">def</span> <span class="nf">do_tls_handshake</span><span class="p">(</span><span class="n">sock</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">tls_obj</span><span class="p">,</span> <span class="n">tls_in_buff</span><span class="p">:</span> <span class="n">ssl</span><span class="o">.</span><span class="n">MemoryBIO</span><span class="p">,</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-6"><code data-line-number=" 6"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-6" name="rest_code_095f5aea8f354d988a71f02eb47a8651-6"></a>                     <span class="n">tls_out_buff</span><span class="p">:</span> <span class="n">ssl</span><span class="o">.</span><span class="n">MemoryBIO</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-7"><code data-line-number=" 7"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-7" name="rest_code_095f5aea8f354d988a71f02eb47a8651-7"></a>    <span class="n">client_hello</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-8"><code data-line-number=" 8"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-8" name="rest_code_095f5aea8f354d988a71f02eb47a8651-8"></a>    <span class="n">tls_in_buff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">client_hello</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-9"><code data-line-number=" 9"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-9" name="rest_code_095f5aea8f354d988a71f02eb47a8651-9"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-10"><code data-line-number="10"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-10" name="rest_code_095f5aea8f354d988a71f02eb47a8651-10"></a>    <span class="k">try</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-11"><code data-line-number="11"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-11" name="rest_code_095f5aea8f354d988a71f02eb47a8651-11"></a>        <span class="n">tls_obj</span><span class="o">.</span><span class="n">do_handshake</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-12"><code data-line-number="12"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-12" name="rest_code_095f5aea8f354d988a71f02eb47a8651-12"></a>    <span class="k">except</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLWantReadError</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-13"><code data-line-number="13"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-13" name="rest_code_095f5aea8f354d988a71f02eb47a8651-13"></a>        <span class="n">server_hello</span> <span class="o">=</span> <span class="n">tls_out_buff</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-14"><code data-line-number="14"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-14" name="rest_code_095f5aea8f354d988a71f02eb47a8651-14"></a>        <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">server_hello</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-15"><code data-line-number="15"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-15" name="rest_code_095f5aea8f354d988a71f02eb47a8651-15"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-16"><code data-line-number="16"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-16" name="rest_code_095f5aea8f354d988a71f02eb47a8651-16"></a>    <span class="n">client_fin</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-17"><code data-line-number="17"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-17" name="rest_code_095f5aea8f354d988a71f02eb47a8651-17"></a>    <span class="n">tls_in_buff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">client_fin</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-18"><code data-line-number="18"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-18" name="rest_code_095f5aea8f354d988a71f02eb47a8651-18"></a>    <span class="n">tls_obj</span><span class="o">.</span><span class="n">do_handshake</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-19"><code data-line-number="19"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-19" name="rest_code_095f5aea8f354d988a71f02eb47a8651-19"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-20"><code data-line-number="20"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-20" name="rest_code_095f5aea8f354d988a71f02eb47a8651-20"></a>    <span class="n">server_fin</span> <span class="o">=</span> <span class="n">tls_out_buff</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-21"><code data-line-number="21"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-21" name="rest_code_095f5aea8f354d988a71f02eb47a8651-21"></a>    <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">server_fin</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-22"><code data-line-number="22"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-22" name="rest_code_095f5aea8f354d988a71f02eb47a8651-22"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-23"><code data-line-number="23"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-23" name="rest_code_095f5aea8f354d988a71f02eb47a8651-23"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-24"><code data-line-number="24"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-24" name="rest_code_095f5aea8f354d988a71f02eb47a8651-24"></a><span class="k">def</span> <span class="nf">make_tls_objects</span><span class="p">():</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-25"><code data-line-number="25"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-25" name="rest_code_095f5aea8f354d988a71f02eb47a8651-25"></a>    <span class="n">tls_in_buff</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">MemoryBIO</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-26"><code data-line-number="26"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-26" name="rest_code_095f5aea8f354d988a71f02eb47a8651-26"></a>    <span class="n">tls_out_buff</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">MemoryBIO</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-27"><code data-line-number="27"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-27" name="rest_code_095f5aea8f354d988a71f02eb47a8651-27"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-28"><code data-line-number="28"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-28" name="rest_code_095f5aea8f354d988a71f02eb47a8651-28"></a>    <span class="n">ctx</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_SSLv23</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-29"><code data-line-number="29"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-29" name="rest_code_095f5aea8f354d988a71f02eb47a8651-29"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="s1">'localhost.crt'</span><span class="p">,</span> <span class="s1">'private_key.pem'</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-30"><code data-line-number="30"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-30" name="rest_code_095f5aea8f354d988a71f02eb47a8651-30"></a>    <span class="n">tls_obj</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">wrap_bio</span><span class="p">(</span><span class="n">tls_in_buff</span><span class="p">,</span> <span class="n">tls_out_buff</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-31"><code data-line-number="31"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-31" name="rest_code_095f5aea8f354d988a71f02eb47a8651-31"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-32"><code data-line-number="32"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-32" name="rest_code_095f5aea8f354d988a71f02eb47a8651-32"></a>    <span class="k">return</span> <span class="n">tls_obj</span><span class="p">,</span> <span class="n">tls_in_buff</span><span class="p">,</span> <span class="n">tls_out_buff</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-33"><code data-line-number="33"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-33" name="rest_code_095f5aea8f354d988a71f02eb47a8651-33"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-34"><code data-line-number="34"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-34" name="rest_code_095f5aea8f354d988a71f02eb47a8651-34"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-35"><code data-line-number="35"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-35" name="rest_code_095f5aea8f354d988a71f02eb47a8651-35"></a><span class="k">def</span> <span class="nf">respond_to_http_request</span><span class="p">(</span><span class="n">sock</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-36"><code data-line-number="36"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-36" name="rest_code_095f5aea8f354d988a71f02eb47a8651-36"></a>    <span class="n">tls_obj</span><span class="p">,</span> <span class="n">tls_in_buff</span><span class="p">,</span> <span class="n">tls_out_buff</span> <span class="o">=</span> <span class="n">make_tls_objects</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-37"><code data-line-number="37"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-37" name="rest_code_095f5aea8f354d988a71f02eb47a8651-37"></a>    <span class="n">do_tls_handshake</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">tls_obj</span><span class="p">,</span> <span class="n">tls_in_buff</span><span class="p">,</span> <span class="n">tls_out_buff</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-38"><code data-line-number="38"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-38" name="rest_code_095f5aea8f354d988a71f02eb47a8651-38"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-39"><code data-line-number="39"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-39" name="rest_code_095f5aea8f354d988a71f02eb47a8651-39"></a>    <span class="n">tls_in_buff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">))</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-40"><code data-line-number="40"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-40" name="rest_code_095f5aea8f354d988a71f02eb47a8651-40"></a>    <span class="n">http_req</span> <span class="o">=</span> <span class="n">tls_obj</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-41"><code data-line-number="41"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-41" name="rest_code_095f5aea8f354d988a71f02eb47a8651-41"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">http_req</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-42"><code data-line-number="42"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-42" name="rest_code_095f5aea8f354d988a71f02eb47a8651-42"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-43"><code data-line-number="43"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-43" name="rest_code_095f5aea8f354d988a71f02eb47a8651-43"></a>    <span class="n">tls_obj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">b</span><span class="s1">'HTTP/1.1 200 OK</span><span class="se">\r\n\r\n</span><span class="s1">'</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-44"><code data-line-number="44"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-44" name="rest_code_095f5aea8f354d988a71f02eb47a8651-44"></a>    <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">tls_out_buff</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-45"><code data-line-number="45"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-45" name="rest_code_095f5aea8f354d988a71f02eb47a8651-45"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-46"><code data-line-number="46"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-46" name="rest_code_095f5aea8f354d988a71f02eb47a8651-46"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-47"><code data-line-number="47"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-47" name="rest_code_095f5aea8f354d988a71f02eb47a8651-47"></a><span class="n">server_sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-48"><code data-line-number="48"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-48" name="rest_code_095f5aea8f354d988a71f02eb47a8651-48"></a><span class="n">server_sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s1">'0.0.0.0'</span><span class="p">,</span> <span class="mi">5000</span><span class="p">))</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-49"><code data-line-number="49"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-49" name="rest_code_095f5aea8f354d988a71f02eb47a8651-49"></a><span class="n">server_sock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">65535</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-50"><code data-line-number="50"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-50" name="rest_code_095f5aea8f354d988a71f02eb47a8651-50"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-51"><code data-line-number="51"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-51" name="rest_code_095f5aea8f354d988a71f02eb47a8651-51"></a><span class="n">client_sock</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">server_sock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-52"><code data-line-number="52"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-52" name="rest_code_095f5aea8f354d988a71f02eb47a8651-52"></a><span class="n">respond_to_http_request</span><span class="p">(</span><span class="n">client_sock</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_095f5aea8f354d988a71f02eb47a8651-53"><code data-line-number="53"></code></a></td>
<td class="code"><code><a id="rest_code_095f5aea8f354d988a71f02eb47a8651-53" name="rest_code_095f5aea8f354d988a71f02eb47a8651-53"></a><span class="n">client_sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></td>
</tr>
</table></div></section>
</div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/python/" rel="tag">python</a></li>
            <li><a class="tag p-category" href="../../categories/python3/" rel="tag">python3</a></li>
            <li><a class="tag p-category" href="../../categories/ssl/" rel="tag">ssl</a></li>
            <li><a class="tag p-category" href="../../categories/tls/" rel="tag">tls</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../async-write-to-stdout-slower-than-print/" rel="prev" title="Async write to stdout slower than print?">Previous post</a>
            </li>
            <li class="next">
                <a href="../opportunistic-tls-with-python-asyncio/" rel="next" title="Opportunistic TLS with python asyncio">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
            

        </section></article><!--End of body content--><footer id="footer">
            Contents © 2022         <a href="mailto:balciunas90@gmail.com">Povilas Balciunas</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>

        <script src="../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
