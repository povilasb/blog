<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="How NAT works?">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Network Address Translation | Povilas Blog</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="http://blog.povilasb.com/posts/network-address-translation/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Povilas Balciunas">
<link rel="prev" href="../silence-does-not-mean-stagnation/" title="Silence does not mean stagnation" type="text/html">
<meta property="og:site_name" content="Povilas Blog">
<meta property="og:title" content="Network Address Translation">
<meta property="og:url" content="http://blog.povilasb.com/posts/network-address-translation/">
<meta property="og:description" content="How NAT works?">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2019-01-20T19:39:39+02:00">
<meta property="article:tag" content="nat">
<meta property="article:tag" content="networking">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark
bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="../../">

            <span id="blog-title">Povilas Blog</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../archive.html" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="../../categories/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">RSS feed</a>

                
            </li>
</ul>
<ul class="navbar-nav navbar-right">
<li class="nav-item">
    <a href="index.md" id="sourcelink" class="nav-link">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Network Address Translation</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Povilas Balciunas
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2019-01-20T19:39:39+02:00" itemprop="datePublished" title="2019-01-20 19:39">2019-01-20 19:39</time></a>
            </p>
                <p class="commentline">    

                    </p>
<p class="sourceline"><a href="index.md" class="sourcelink">Source</a></p>

        </div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>There is a lot of resources on the Internet explaining how NAT works, but I
just want to have a post here that will lay the foundations for the subsequent
post I was meaning to write - <a href="https://en.wikipedia.org/wiki/Hole_punching_%28networking%29">hole
punching</a>.
Network Address Translation (later simply NAT) is a method to connect multiple
LAN devices to the Internet via a single IP address. NAT is implemented by
our home routers. Technically speaking NAT changes source IP and source port
fields of every outgoing UDP/TCP packet and destination IP and port of every
incoming packet.</p>
<h3>Example</h3>
<div class="code"><pre class="code literal-block">                   +---------------+
                   | Target Server |
                   |    1.1.1.1    |
                   +---------------+
                          ^
                          |                            Packet source IP and
                          |                          / port number are
      +---------------------------------------------+  overwritten by our router
      |                TCP/UDP Packet               |
      +-------------+----------+---------+----------+
      |    SRC_IP   | SRC_PORT | DST_IP  | DST_PORT |
      +-------------+----------+---------+----------+
      | 78.53.1.5   |   7000   | 1.1.1.1 |   80     |
      +-------------+----------+---------+----------+
                          |
                          |
                  +---------------+
                  |   78.53.1.5   | - Router IP assigned by our ISP
                  |               |
                  |     Router    |
                  |               |
                  | 192.168.1.254 | - Router IP on Local Area Network
                  +---------------+
                          ^
                          |                            Our machine on LAN
                          |                          / sends this packet to
      +---------------------------------------------+  the 1.1.1.1 server
      |                TCP/UDP Packet               |
      +-------------+----------+---------+----------+
      |    SRC_IP   | SRC_PORT | DST_IP  | DST_PORT |
      +-------------+----------+---------+----------+
      | 192.168.1.5 |   5000   | 1.1.1.1 |   80     |
      +-------------+----------+---------+----------+
                          ^
                          |
                          |
                    +-------------+
                    |  PC on LAN  |
                    | 192.168.1.5 |
                    +-------------+
</pre></div>

<h3>NAT Table</h3>
<p>The fundamental way NAT works is pretty straightforward:</p>
<ol>
<li>Router keeps a table of port mappings - NAT table. As new packets travel
   through the router this table is updated, e.g.</li>
</ol>
<div class="code"><pre class="code literal-block">    +----------+-------------+----------+-------------+----------+----------+
    | Protocol |    SRC_IP   | SRC_PORT |    DST_IP   | DST_PORT | NEW_PORT |
    +----------+-------------+----------+-------------+----------+----------+
    |    UDP   | 192.168.1.5 |   5000   |   1.1.1.1   |   80     |  7000    |
    +----------+-------------+----------+-------------+----------+----------+
</pre></div>

<ol>
<li>
<p>Before packet is sent over the Internet, it's source port will be replaced
   with <code>NEW_PORT</code>. So this is the port, the target server will see when the
   packet arrives.</p>
</li>
<li>
<p>When incoming packet is received, router finds a row in the NAT table whose
   <code>NEW_PORT</code> matches packet destination port. Then it forwards the packet
   to machine on LAN using <code>SRC_IP</code>:<code>SRC_PORT</code> information from NAT table.</p>
</li>
</ol>
<div class="code"><pre class="code literal-block">                   +---------------+
                   | Target Server |
                   |    1.1.1.1    |
                   +---------------+
                          |
                          |
                          V
      +-----------------------------------------------+
      |                  TCP/UDP Packet               |
      +-------------+----------+-----------+----------+
      |    SRC_IP   | SRC_PORT | DST_IP    | DST_PORT |
      +-------------+----------+-----------+----------+
      |   1.1.1.1   |    80    | 78.53.1.5 |   7000   |
      +-------------+----------+-----------+----------+
                          |
                          |
                  +---------------+
                  |   78.53.1.5   | - Router IP assigned by our ISP
                  |               |
                  |     Router    |
                  |               |
                  | 192.168.1.254 | - Router IP on Local Area Network
                  +---------------+
                          |
                          |
                          V
      +-------------------------------------------------+
      |                  TCP/UDP Packet                 |
      +-------------+----------+-------------+----------+
      |    SRC_IP   | SRC_PORT |   DST_IP    | DST_PORT |
      +-------------+----------+-------------+----------+
      |   1.1.1.1   |    80    | 192.168.1.5 |   5000   |
      +-------------+----------+-------------+----------+
                          |
                          |
                          V
                    +-------------+
                    |  PC on LAN  |
                    | 192.168.1.5 |
                    +-------------+
</pre></div>

<h3>NAT types</h3>
<p>Depending on how <code>NEW_PORT</code> is assigned NATs fall under 2 categories:
EIM (Endpoint Independent Mapping) and EDM (Endpoint Dependent Mapping).</p>
<h4>Endpoint independent mapping NAT</h4>
<p>EIM NAT<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> (those abbreviations can get pretty arcane, hugh? :D) assigns
unique <code>NEW_PORT</code> for each unique <code>(Protocol, SRC_IP, SRC_PORT)</code> tuple. Let's
see an example.</p>
<p>Say we have an empty NAT table:</p>
<div class="code"><pre class="code literal-block">    +----------+-------------+----------+-------------+----------+----------+
    | Protocol |    SRC_IP   | SRC_PORT |    DST_IP   | DST_PORT | NEW_PORT |
    +----------+-------------+----------+-------------+----------+----------+
</pre></div>

<p>Then we send UDP packet to <code>1.1.1.1:80</code> . Network Address Translation kicks off
and does it's job:</p>
<div class="code"><pre class="code literal-block">    +----------+-------------+----------+-------------+----------+----------+
    | Protocol |    SRC_IP   | SRC_PORT |    DST_IP   | DST_PORT | NEW_PORT |
    +----------+-------------+----------+-------------+----------+----------+
    |    UDP   | 192.168.1.5 |   5000   |   1.1.1.1   |   80     |  7000    |
    +----------+-------------+----------+-------------+----------+----------+
</pre></div>

<p>We send another UDP packet with the same source IP and port (this is possible
if we use the same UDP socket), but this time to <code>8.8.8.8:80</code>. This time NAT
table already has an entry for source endpoint <code>192.168.1.5:5000</code>, so another
one won't be added:</p>
<div class="code"><pre class="code literal-block">    +----------+-------------+----------+-------------+----------+----------+
    | Protocol |    SRC_IP   | SRC_PORT |    DST_IP   | DST_PORT | NEW_PORT |
    +----------+-------------+----------+-------------+----------+----------+
    |    UDP   | 192.168.1.5 |   5000   |   1.1.1.1   |   80     |  7000    |
    +----------+-------------+----------+-------------+----------+----------+
</pre></div>

<p>We send yet another UDP packet, but this time we use different source IP
and/or port. EIM NAT will add a new port mapping in this case:</p>
<div class="code"><pre class="code literal-block">    +----------+-------------+----------+-------------+----------+----------+
    | Protocol |    SRC_IP   | SRC_PORT |    DST_IP   | DST_PORT | NEW_PORT |
    +----------+-------------+----------+-------------+----------+----------+
    |    UDP   | 192.168.1.5 |   5000   |   1.1.1.1   |   80     |  7000    |
    |    UDP   | 192.168.1.5 |   6000   |   1.1.1.1   |   80     |  8000    |
    +----------+-------------+----------+-------------+----------+----------+
</pre></div>

<h4>Endpoint dependent mapping NAT</h4>
<p>It is also known as symmetric NAT<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>. EDM NAT assigns unique <code>NEW_PORT</code> for
each unique tuple <code>(Protocol, SRC_IP, SRC_PORT, DST_IP, DST_PORT)</code>. Let's
see an example.</p>
<p>Let's start with a NAT table containing a single entry</p>
<div class="code"><pre class="code literal-block">    +----------+-------------+----------+-------------+----------+----------+
    | Protocol |    SRC_IP   | SRC_PORT |    DST_IP   | DST_PORT | NEW_PORT |
    +----------+-------------+----------+-------------+----------+----------+
    |    UDP   | 192.168.1.5 |   5000   |   1.1.1.1   |   80     |  7000    |
    +----------+-------------+----------+-------------+----------+----------+
</pre></div>

<p>We send another UDP packet with the same source IP and port to different target
server <code>8.8.8.8:80</code>. Since NAT table does not have an entry to this endpoing,
new port mapping will be added:</p>
<div class="code"><pre class="code literal-block">    +----------+-------------+----------+-------------+----------+----------+
    | Protocol |    SRC_IP   | SRC_PORT |    DST_IP   | DST_PORT | NEW_PORT |
    +----------+-------------+----------+-------------+----------+----------+
    |    UDP   | 192.168.1.5 |   5000   |   1.1.1.1   |   80     |  7000    |
    |    UDP   | 192.168.1.5 |   5000   |   8.8.8.8   |   80     |  8000    |
    +----------+-------------+----------+-------------+----------+----------+
</pre></div>

<p>Say we send another packet, this time to the same IP address, but different
port. Even in this case new port mapping will be added:</p>
<div class="code"><pre class="code literal-block">    +----------+-------------+----------+-------------+----------+----------+
    | Protocol |    SRC_IP   | SRC_PORT |    DST_IP   | DST_PORT | NEW_PORT |
    +----------+-------------+----------+-------------+----------+----------+
    |    UDP   | 192.168.1.5 |   5000   |   1.1.1.1   |   80     |  7000    |
    |    UDP   | 192.168.1.5 |   5000   |   8.8.8.8   |   80     |  8000    |
    |    UDP   | 192.168.1.5 |   5000   |   8.8.8.8   |   443    |  9000    |
    +----------+-------------+----------+-------------+----------+----------+
</pre></div>

<h3>NAT filtering types</h3>
<p>NATs can be grouped into different types based on how they filter incoming
packets<sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup>:</p>
<ul>
<li>full cone NAT</li>
<li>port restricted cone NAT</li>
</ul>
<h4>Full cone NAT</h4>
<p>This is the least restrictive type of NAT. Full cone NAT allows any incoming
packet whose destination port matches some <code>NEW_PORT</code> in NAT table.</p>
<p>E.g. say we have such NAT table:</p>
<div class="code"><pre class="code literal-block">    +----------+-------------+----------+-------------+----------+----------+
    | Protocol |    SRC_IP   | SRC_PORT |    DST_IP   | DST_PORT | NEW_PORT |
    +----------+-------------+----------+-------------+----------+----------+
    |    UDP   | 192.168.1.5 |   5000   |   1.1.1.1   |   80     |  7000    |
    |    UDP   | 192.168.1.8 |   5000   |   8.8.8.8   |   80     |  8000    |
    +----------+-------------+----------+-------------+----------+----------+
</pre></div>

<p>Then the packet arrives to our router:</p>
<div class="code"><pre class="code literal-block">      +-----------------------------------------------+
      |                  UDP Packet                   |
      +-------------+----------+-----------+----------+
      |    SRC_IP   | SRC_PORT | DST_IP    | DST_PORT |
      +-------------+----------+-----------+----------+
      |   1.1.1.1   |    80    | 78.53.1.5 |   7000   |
      +-------------+----------+-----------+----------+
                          |
                          |
                          V
                  +---------------+
                  |   78.53.1.5   |
                  |               |
                  |     Router    |
                  |               |
                  | 192.168.1.254 |
                  +---------------+
                         |
                         | ----- Packet is forwarded to 192.168.1.5
                         V
</pre></div>

<p>The destination port of a packet (<code>7000</code>) is matched with <code>NEW_PORT</code> in
router's NAT table. Since we find an entry, the packet is forwarded.
Let's take another example. Say we have the same NAT table, but the incoming
packet is:</p>
<div class="code"><pre class="code literal-block">      +-----------------------------------------------+
      |                  UDP Packet                   |
      +-------------+----------+-----------+----------+
      |    SRC_IP   | SRC_PORT | DST_IP    | DST_PORT |
      +-------------+----------+-----------+----------+
      |   1.1.1.1   |    80    | 78.53.1.5 |   6000   |
      +-------------+----------+-----------+----------+
                          |
                          |
                          V
                  +---------------+
                  |   78.53.1.5   |
                  |               |
                  |     Router    |
                  |               |
                  | 192.168.1.254 |
                  +---------------+
                         |
                         X ----- Packet is dropped
                         V
</pre></div>

<p>This packet will be discarded since its destination port <code>6000</code> does not
exist in NAT under <code>NEW_PORT</code> column.</p>
<p>Finally, I'd like to give another example:</p>
<div class="code"><pre class="code literal-block">      +-----------------------------------------------+
      |                  UDP Packet                   |
      +-------------+----------+-----------+----------+
      |    SRC_IP   | SRC_PORT | DST_IP    | DST_PORT |
      +-------------+----------+-----------+----------+
      | 86.100.4.5  |  87634   | 78.53.1.5 |   8000   |
      +-------------+----------+-----------+----------+
                          |
                          |
                          V
                  +---------------+
                  |   78.53.1.5   |
                  |               |
                  |     Router    |
                  |               |
                  | 192.168.1.254 |
                  +---------------+
                         |
                         | ----- Packet is forwarded to 192.168.1.5
                         V
</pre></div>

<p>Notice how this packet is forwarded even though it's originating from a
random source machine. This is full cone NAT in a nutshell - it allows packets
go through as long as their destination port is inside NAT table.</p>
<h4>Port restricted cone NAT</h4>
<p>This is the most restrictive NAT. It allows incoming packets only from
endpoints that we sent the packet to before. That means</p>
<ol>
<li>destination port of a packet must match <code>NEW_PORT</code> in NAT table;</li>
<li>source IP and port of a packet must match destination IP and port of the
   same row in NAT table.</li>
</ol>
<p>So say we have a NAT table:</p>
<div class="code"><pre class="code literal-block">    +----------+-------------+----------+-------------+----------+----------+
    | Protocol |    SRC_IP   | SRC_PORT |    DST_IP   | DST_PORT | NEW_PORT |
    +----------+-------------+----------+-------------+----------+----------+
    |    UDP   | 192.168.1.5 |   5000   |   1.1.1.1   |   80     |  7000    |
    +----------+-------------+----------+-------------+----------+----------+
</pre></div>

<p>Then UDP packet with <code>(SRC_IP=1.1.1.1, SRC_PORT=80, DST_IP=78.53.1.5, DST_PORT=7000)</code>
will be allowed, but these packets will be dropped:</p>
<ul>
<li><code>(SRC_IP=1.1.1.1, SRC_PORT=80, DST_IP=78.53.1.5, DST_PORT=6000)</code></li>
<li><code>(SRC_IP=1.1.1.1, SRC_PORT=443, DST_IP=78.53.1.5, DST_PORT=7000)</code></li>
<li><code>(SRC_IP=8.8.8.8, SRC_PORT=80, DST_IP=78.53.1.5, DST_PORT=7000)</code></li>
</ul>
<h3>Glossary</h3>
<p>endpoint - IP:port pair.</p>
<div class="footnote">
<hr>
<ol>
<li id="fn:1">
<p>https://docs.rs/p2p/0.6.0/p2p/#endpoint-independent-mapping-eim <a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn:2">
<p>https://www.think-like-a-computer.com/2011/09/19/symmetric-nat/ <a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
<li id="fn:3">
<p>https://www.think-like-a-computer.com/2011/09/16/types-of-nat <a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">↩</a></p>
</li>
</ol>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/nat/" rel="tag">nat</a></li>
            <li><a class="tag p-category" href="../../categories/networking/" rel="tag">networking</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../silence-does-not-mean-stagnation/" rel="prev" title="Silence does not mean stagnation">Previous post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
            

        </section></article><!--End of body content--><footer id="footer">
            Contents © 2022         <a href="mailto:balciunas90@gmail.com">Povilas Balciunas</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>

        <script src="../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
